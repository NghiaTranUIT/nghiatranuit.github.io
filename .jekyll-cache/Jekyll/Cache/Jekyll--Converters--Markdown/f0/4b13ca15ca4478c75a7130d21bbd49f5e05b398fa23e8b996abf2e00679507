I"p.<p>Hello guy, in this blog we will discuss some technique for filtering photo like instagram.</p>

<p>Nowaday, If you take a tour around AppStore, you will realize more than 80% app which has filter photo or video ability. This is the must-have featured in your app especially social app or photo video editor app.</p>

<p>If you are fresh developer like me before, I ensure you must have a question like that “How can I bring awesome featured to my app” or “Where can I find snippet code to implement it easily more than else ? ”</p>

<p>With more 1 year deal with image processing, I have some mysterious thing to show you. I will split to 3 part blog. Sort by level, from easy to advanced.</p>

<p>In this blog, I will cover some famous image-process Framework in the world, and the easy way to implement it.</p>

<h2 id="core-image">Core Image</h2>

<p>Core Image is powerful framework let you apple easily filter to your photo such as modifying contact, hue, vibrance,…. Core Image was built with a ton of filter, include common filter and high-up filter.</p>

<p>Core Image mainly process your photo by CPU and GPU. So fast enough to process each frame in high quality video. With Core Image, you can apply chain of filters to make a whole-new filter. Each filter has own parameter to adjust behaviour, so you can built professional editor app.</p>

<p>But Core Image also some limit.</p>

<h2 id="gpuimage">GPUImage</h2>

<p>GPUImage is very similar Core Image. The awesome framework was built by BradLarson.</p>

<p>You can check it out in at his <a href="https://github.com/BradLarson/GPUImage" title="github">github</a>.</p>

<p>The different things between them is GPUImage was build on top OpenGL ES. So GPUImage can take all powerful advantage of GPU. GPU provide many stuff for you to apply filter to photo, or filter real-time video.</p>

<p>For massively parallel operations like processing images or live video frames, GPUs have some significant performance advantages over CPUs. On an iPhone 4, a simple image filter can be over 100 times faster to perform on the GPU than an equivalent CPU-based filter.</p>

<p>You can create own custom filter with GPUImage, but you must have a little knowledge about OpenGL ES and OpenGL Shading Language.</p>

<p>Here is a chart comparison between GPUImage vs Core Image by Brad Larson</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/chart_1.png" alt="" /></p>

<p>You see, in case processing video, GPUImage took 2,5ms to upload frame from camera, apply gamma filter and display to screen, versus 106 ms for the same operation using Core Image.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/chart_2.png" alt="" /></p>

<p>One more time, GPUImage process photo faster 4x more than Core Image in some common case.</p>

<h2 id="limit">Limit</h2>

<p>So, Is GPUImage the best choice for editor iOS app ?</p>

<p>No, everything always have two-side. When I deal with GPUImage, I often get error when build project which add GPUImage static library in 64-bit chip. And get many warning if I add GPUImage as independent project. You can ignore warnings, but It make too much noise.</p>

<p>For customize filter, you must write custom filter by OpenGL Shading Language which is low-level language.</p>

<p>What about Core Image ?</p>

<p>Core Image also include ton of filter. But you can custom it by own. But to adding Core Image to project is very very simple.</p>

<p>Using like that :</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">filePath</span> <span class="o">=</span>
  <span class="p">[[</span><span class="n">NSBundle</span> <span class="nf">mainBundle</span><span class="p">]</span> <span class="nf">pathForResource</span><span class="p">:</span><span class="s">@"image"</span> <span class="nf">ofType</span><span class="p">:</span><span class="s">@"png"</span><span class="p">];</span>
<span class="n">NSURL</span> <span class="o">*</span><span class="n">fileNameAndPath</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nf">fileURLWithPath</span><span class="p">:</span><span class="n">filePath</span><span class="p">];</span>
 
<span class="c1">// 2</span>
<span class="n">CIImage</span> <span class="o">*</span><span class="n">beginImage</span> <span class="o">=</span>
  <span class="p">[</span><span class="n">CIImage</span> <span class="nf">imageWithContentsOfURL</span><span class="p">:</span><span class="n">fileNameAndPath</span><span class="p">];</span>
 
<span class="c1">// 3</span>
<span class="n">CIFilter</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="p">[</span><span class="n">CIFilter</span> <span class="nf">filterWithName</span><span class="p">:</span><span class="s">@"CISepiaTone"</span>
                              <span class="nl">keysAndValues:</span> <span class="n">kCIInputImageKey</span><span class="p">,</span> <span class="n">beginImage</span><span class="p">,</span>
                    <span class="s">@"inputIntensity"</span><span class="p">,</span> <span class="mf">@0.8</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
<span class="n">CIImage</span> <span class="o">*</span><span class="n">outputImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter</span> <span class="nf">outputImage</span><span class="p">];</span>
 
<span class="c1">// 4</span>
<span class="n">UIImage</span> <span class="o">*</span><span class="n">newImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="nf">imageWithCIImage</span><span class="p">:</span><span class="n">outputImage</span><span class="p">];</span>
<span class="n">self</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">newImage</span><span class="p">;</span>
</code></pre></div></div>

<ol>
  <li> Init Path for Image in bundle</li>
  <li>Init CIImage</li>
  <li>Init SepiaTone Filter, and configure some parameter</li>
  <li>Get filtered image out.</li>
</ol>

<h2 id="pre-filter">Pre-filter</h2>

<p>If you want to re-create photo in iOS App within the filter, you can use the Core Image to implement a series of CIFilter. CIFilter offers can adjust the brightness, contrast and so a variety of special effects filters.</p>

<p>But there are mysterious approach, we can directly use Photoshop and other image processing software, directly adjust these color parameters, export some pattern, and use this pattern to apply photo again, We can dramatically speed up development.</p>

<h2 id="tone-curve">Tone Curve</h2>

<p>Tone Curve is the simplest way to apply filter. The Tone Curve tool in photoshop is designed to allow you to modify the various light levels found within an image in a way that will give you greater control over the tonal range and contrast of your photograph.</p>

<p>As we capture our images we are capturing an array of light from the scene. From the darkest of the shadows to the whitest of the highlights the Tone Curve gives us a way of visually modifying how these levels of lights appear in the final image.</p>

<p>We use Photoshop to create own tone curve, and apply it to photo by Core Image.</p>

<p>Open Photoshop</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/Curve_blog_1.png?resize=303%2C143" alt="Curve_blog_1" /></p>

<p> Take <a href="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/toneCurve_photoshop_before.jpg" title="Original Photo">Original Photo</a> I prepared for you.</p>

<p>Open with photoshop</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/Curve_blog_2.png?resize=829%2C518" alt="Curve_blog_2" /></p>

<p>Go to Image -&gt; Adjustments -&gt; Curves …</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/Curve_blog_3.png?resize=508%2C205" alt="Curve_blog_3" /></p>

<p>Here is Tone Curve tool. You can easily tone of R G or G by drag each point. I created sample <a href="http://www.mediafire.com/download/swbfvzvx6ckd6gg/customToneCurve.acv" title="Sample_Tone_Curve">Sample_Tone_Curve</a>  for you.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/Curve_blog_4.png?resize=396%2C466" alt="Curve_blog_4" /></p>

<p>By changing each point in tone curve tool, we can see realtime filtered photo. And here is my result. </p>

<p><strong>After</strong></p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/toneCurve_photoshop_before.jpg?resize=744%2C495" alt="toneCurve_photoshop_before" /></p>

<p><strong>Before</strong></p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/toneCurve_photoshop_after.jpg?resize=744%2C496" alt="toneCurve_photoshop_after" /> </p>

<p>Yep, the second photo look pretty than original. The finally, you should export to “Curve file”.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2014/06/Curve_blog_5.png?resize=129%2C131" alt="Curve_blog_5" /></p>

<p>You can apply “curve file” to your photo easily. Just download <a href="https://github.com/BradLarson/GPUImage" title="GPUImage">GPUImage</a> here.</p>

<p>Add GPUImage to your project as independent project or build static library. Just a couple of code</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span><span class="p">(</span><span class="n">UIImage</span> <span class="o">*</span><span class="p">)</span> <span class="nf">imageByFitering</span><span class="p">:(</span><span class="n">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="nv">image</span>
<span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"filter with %@"</span><span class="p">,</span><span class="n">_filterNameACV</span><span class="p">);</span>
    
    <span class="n">GPUImageToneCurveFilter</span> <span class="o">*</span><span class="n">curveFilter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">GPUImageToneCurveFilter</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithACV</span><span class="p">:</span><span class="n">_filterNameACV</span><span class="p">];</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">curveFilter</span> <span class="nf">imageByFilteringImage</span><span class="p">:</span><span class="n">image</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So, what about Core Image. Core Image provide “CIToneCurve” for dev. But there is no method that allow read data from “curve file”. If you still want implement it. You take a deep at <a href="http://www.adobe.com/devnet-apps/photoshop/fileformatashtml/" title="this link">this link</a>. This describe how Structure of Curve file was build. and you can read it by following instruction.</p>

<h2 id="here-we-go">Here we go</h2>

<p>In first series blog about filter photo, I covered some technique that make your photo get beautiful. Built editor photo app as quickly as possible.</p>

<p>Feel free to drop your comment here ;]</p>

<p> </p>

:ET