I"é<p>Hi everyone.¬†Today is the last time I‚Äôve worked at feels. I decided to spend whole weekend to do experiment which I haven‚Äôt done before.</p>

<p>I remember to <a href="https://uber.github.io/deck.gl/#/">deck.gl</a>, popular opensource published by Uber. Why don‚Äôt we get a try ? üòâ</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_28.jpg" alt="" /></p>

<p>I tried installing Deck.gl, MapBox, implement some code, take a deep understand in GLSL. Tried to visualize VisaH1B static, Flight record, Taxi route. All datasets are available on Kaggle which under CC license.</p>

<p>And now, it‚Äôs time to write blog for sharing my experiment.</p>

<p>Hope you enjoy it :]</p>

<h2 id="1-data-visualization">1. Data Visualization</h2>

<p>Data Visualization is quite fun. Perhaps when you see the term ‚ÄúData Visualization‚Äù, you might remember to ugly Microsoft Excel‚Äôs spreadsheet chart. In real world, there are many situations we need to visualize the data.</p>

<ul>
  <li>If you‚Äôre student, before going to big final semester presentation, you would like to be stand out. What would you do?</li>
  <li>If you‚Äôre founder, I believe you had one time that shows off your growth user over the world to potential investors, and you want¬†to make impression¬†on the first sight. What do you do?</li>
</ul>

<p>I believe we‚Äôre using the same chart like below. It‚Äôs so common, trivial.</p>

<p><img src="https://i0.wp.com/www.excel-easy.com/data-analysis/images/charts/column-chart.png?w=850" alt="" /></p>

<p>There are millions of people did that. If you would like to be stand out. Please don‚Äôt do the same way with hundred people did before. üòé</p>

<h4 id="brave-world">Brave world</h4>

<p><img src="https://i2.wp.com/s-media-cache-ak0.pinimg.com/originals/22/32/22/22322282dac474a138666b7e79cd5bd1.jpg" alt="" />
<img src="https://i0.wp.com/data-ink.com/wp-content/uploads/2016/12/Cancer-Deaths-by-County.png" alt="" /></p>

<p>As you can see, data visualization is really catch-eye.</p>

<h3 id="props">Props</h3>

<ul>
  <li>It can be accessed quickly by a wider audience.</li>
  <li>It conveys a lot of information in a small space.</li>
  <li>It makes your report more visually appealing.</li>
</ul>

<h3 id="cons">Cons</h3>

<ul>
  <li>You must put more <strong>effort</strong>.</li>
</ul>

<p>It‚Äôs boring if we keep doing every time. I would be better if we put myself into a dangerous zone, try somethings new, push to boundary.</p>

<h2 id="2-roadmap">2. Roadmap</h2>

<p>This experiment will show you how to visualize million of records in world-map.</p>

<p>You will understand</p>

<ul>
  <li>How to use vector-based Mapbox SDK, and able to custom map with own style.</li>
  <li>How to use Deck.gl, a WebGL-powerful framework for visual exploratory data analysis of large datasets.</li>
  <li>Visualize the location of 1 million trees in New York city with ScreenGridLayer</li>
  <li>Experiment on Heatmap</li>
  <li>Visualize the flight record data by using¬†FlightLayer</li>
  <li>Combination: GLSL shaders and Deck.gl to achieve dynamic-map.</li>
</ul>

<p>Here are screenshots.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_1.jpg" alt="" />
<strong>683.788</strong> trees in NY by ScreenGridLayer, run smoothly at 60FPS</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_2.jpg" alt="" /></p>

<p>The square,¬†brighter¬†green colors, means more trees round up.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_4.jpg" alt="" /></p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_3.jpg" alt="" /></p>

<p>Heat-map for better look</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/Data-visualization-thumbnail.jpeg" alt="" /></p>

<p>Flight record data with Flightlayer (Static)</p>

<iframe width="560" height="315" src="https://www.youtube.com/watch?v=kgcJ0rftIUA" frameborder="0" allowfullscreen=""></iframe>

<p>Dynamic visualization with GLSL shader</p>

<h2 id="3-technologies">3. Technologies</h2>

<h3 id="31-react-redux">3.1 React-redux</h3>

<p>Before writing actually code. It‚Äôs better if I cover and mention all technologies we‚Äôre using.</p>

<p>[<strong>IMPORTANT</strong>] I assume you‚Äôve already had experience on <a href="https://facebook.github.io/react/">React</a> and <a href="https://github.com/reactjs/redux">Redux</a>. If not, don‚Äôt be shy to follow tutorials on google.</p>

<h3 id="32-mapbox">3.2 MapBox</h3>

<p><a href="https://www.mapbox.com">Mapbox</a> is a large provider of custom online maps for websites such as Foursquare, Pinterest, Evernote, the Financial Times, The Weather Channel and Uber Technologies.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_5.jpg" alt="" /></p>

<p>Mapbox offers a million way to custom your map. Fit with many contextures: Drones, Finance Government, Logistics Media Natural resources, Outdoors, Real estate, Security, Transportation, Travel, ‚Ä¶ Each kind of maps have difference look</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_6.jpg" alt="" /></p>

<p>Mapbox also provides amazing studio, then you can create owner map as well as.</p>

<p>Instead of using mapbox.js officially, I intend to use <a href="https://github.com/uber/react-map-gl">react-map-gl</a>. It‚Äôs React friendly API wrapper around MapboxGL JS. It‚Äôs one of popular library was published by Uber recently with 2.2k ‚≠êÔ∏è.</p>

<h3 id="33-deckgl">3.3 Deck.gl</h3>

<p>Beside react-map-gl. Uber also publish¬†<a href="https://uber.github.io/deck.gl">deck.gl</a>¬†tool.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_7.jpg" alt="" /></p>

<p>There are 3 highlight factors you might consider.</p>

<ol>
  <li>Organize the complex data by following Layered Approach. Makes it easy to package and share new visualizations as reusable layers.</li>
  <li>High-Precision computations in the GPU:¬†By emulating 64-bit floating point computations in the GPU. Deck.gl renders datasets with unparalleled accuracy and performance.</li>
  <li>React and Mapbox GL Integrations: Great match with React, supporting efficient WebGL rendering under the Reactive programming paradigm.</li>
</ol>

<p><a href="https://github.com/uber/deck.gl">Deck.gl</a> deserves more than 1.8k ‚≠êÔ∏è on¬†<a href="https://github.com/uber/deck.gl">Github</a>¬†üíØ</p>

<h3 id="34-kaggle">3.4 Kaggle</h3>

<p>It‚Äôs incompliance if we don‚Äôt have much data for visualization. <a href="https://www.kaggle.com">Kaggle</a> is the best place to get huge data. They offer open datasets on everything from government, health, and science to popular games and dating trends. It‚Äôs really valuable treasure for data mining or training model for deep learning machine ü§ò</p>

<p>As part of this blog. I used <a href="https://www.kaggle.com/nycparks/tree-census">2015 Tree Census in NewYork city</a> and ¬†<a href="https://www.kaggle.com/usdot/flight-delays">2015 Flight Delay and Cancellation</a>. All of them are released under¬†<a href="https://creativecommons.org/publicdomain/zero/1.0/">CC0: Public Domain License</a>. So you can read/write, modify, distribute the data whatever you like. It‚Äôs cool üëç</p>

<h3 id="35-glsl-shader">3.5 GLSL Shader</h3>

<p>I also cover a bit about GLSL Shader. If you‚Äôre learned OpenGL, you must be familiar with this term. I will keep it simple as possible because I don‚Äôt have time to explain deeper.</p>

<p>Basically, GLSL has a syntax similar to C, which is executed directly by the graphics pipeline. There are two types ‚Äî <strong>Vertex Shaders</strong> transforms shape positions to real 3D drawing coordinates. And <strong>Fragment Shaders</strong>¬†helps to render colors and other attributes.</p>

<p>By using GLSL, we can achieve high performance with millions¬†of data on map üòé</p>

<h2 id="4-time-for-coding">4. Time for coding</h2>

<h3 id="41-stater-kit">4.1 Stater kit</h3>

<p>For saving time, I won‚Äôt show you how to install Node, deck.gl or react-map-gl. It‚Äôs waste of time. If you‚Äôre patient, feels free to start new project by yourself. I recommend cloning¬†<a href="https://github.com/davezuko/react-redux-starter-kit">react-redux-starter-kit</a>¬†project. It includes React, Redux, React-router too as basic starter kit.</p>

<p>To begin, please <a href="https://github.com/NghiaTranUIT/data-visualization-deck-gl/tree/starter-pack-updated">download starter pack</a> which I prepared. It contains base React-Redux, LayerInfo, MapSelection, react-map-gl, tween, luml.gl, as well as data from Kaggle.¬†‚Ä¶ all you need are ready ü§ò</p>

<p>After clone starter-pack. Please make sure you run</p>

<p>npm install npm start</p>

<p>It opens <em>localhost</em> automatically, and notice the control at left-bottom. It‚Äôs all we do now üëç</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_17.jpg" alt="" /></p>

<p>Before going through the tutorial, we should take a look at project structure in detail.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_18.jpg" alt="" /></p>

<p>We have project structure here.</p>

<ul>
  <li><strong>./info:</strong> LayerInfo layer</li>
  <li><strong>./modules:</strong> Include action.js and reducer.js of redux</li>
  <li><strong>overlays:</strong> flight_overlay.js, tree_heatmap_overlay, tree_screengrid_layer, taxi_overlay.js. All of them are layer which we implement.</li>
  <li><strong>main.js:</strong>¬†The logic of this example. We will fill render() func to show map and overlay layer off. üëç</li>
  <li><strong>map-selection</strong>: MapSelection control.</li>
</ul>

<h4 id="constantsjs">constants.js</h4>

<p>Define constants, such as MapBoxAccessToken, data source name.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">MapMode</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">NONE</span><span class="p">:</span>             <span class="dl">'</span><span class="s1">NONE</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">TREES</span><span class="p">:</span>            <span class="dl">'</span><span class="s1">TREES</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">TREES_HEATMAP</span><span class="p">:</span>    <span class="dl">'</span><span class="s1">TREES_HEATMAP</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">FLIGHT</span><span class="p">:</span>           <span class="dl">'</span><span class="s1">FLIGHT</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">TAXI</span><span class="p">:</span>             <span class="dl">'</span><span class="s1">TAXI</span><span class="dl">'</span>
<span class="p">}</span>
 
<span class="k">export</span> <span class="kd">const</span> <span class="nx">MAPBOX_ACCESS_TOKEN</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">&lt;insert-your-mapbox-public-token&gt;</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="kd">const</span> <span class="nx">FLIGHT_DATA</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">./example/data/flight-data.csv</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="kd">const</span> <span class="nx">AIRPORT_DATA</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">./example/data/airports.csv</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TREE_DATA</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">./example/data/tree_census.csv</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="kd">const</span> <span class="nx">TAXI_TRIP_DATA</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">./example/data/taxi-trip.json</span><span class="dl">'</span>
</code></pre></div></div>

<h4 id="initial_state">INITIAL_STATE</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">INITIAL_STATE</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">mapViewState</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">latitude</span><span class="p">:</span> <span class="nx">NY_LOCATION</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span>
    <span class="na">longitude</span><span class="p">:</span> <span class="nx">NY_LOCATION</span><span class="p">.</span><span class="nx">longitude</span><span class="p">,</span>
    <span class="na">zoom</span><span class="p">:</span> <span class="mf">11.5</span><span class="p">,</span>
    <span class="na">pitch</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">bearing</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="na">flightArcs</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">airports</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">trees</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">taxi</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="na">mapMode</span><span class="p">:</span> <span class="nx">MapMode</span><span class="p">.</span><span class="nx">NONE</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>INITIAL_STATE defines the main variables. It‚Äôs self-explanatory. When dealing with map, we usually encounter bunch of map context, such as Latitude, longitude, zoom, pitch, bearing. If you don‚Äôt know one of them. Please do short search on google. üòâ</p>

<p>In addition, flightArcs, airports, tress, text and mapMode are main variables which we‚Äôre storing data from CSV or JSON later.</p>

<h4 id="render">render()</h4>

<p>Navigate to bottom of main.js, you will see the render function.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">flightArcs</span><span class="p">,</span> <span class="nx">trees</span><span class="p">,</span> <span class="nx">mapMode</span><span class="p">,</span> <span class="nx">airports</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
  <span class="kd">const</span> <span class="nx">layerInfoProps</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">numberFlights</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getLength</span><span class="p">(</span><span class="nx">flightArcs</span><span class="p">),</span>
    <span class="na">numberTrees</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getLength</span><span class="p">(</span><span class="nx">trees</span><span class="p">),</span>
    <span class="na">numberAirport</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getLength</span><span class="p">(</span><span class="nx">airports</span><span class="p">),</span>
    <span class="na">mode</span><span class="p">:</span> <span class="nx">mapMode</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">mapSelectionProps</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">mapMode</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">mapMode</span><span class="p">,</span>
    <span class="na">selectModeFunc</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_handleSelectMode</span><span class="p">,</span>
    <span class="na">stopTimerFunc</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_handleStopTimer</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
      <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">_renderMap</span><span class="p">()</span> <span class="p">}</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="dl">'</span><span class="s1">overlay-contol-container</span><span class="dl">'</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="nx">MapSelection</span> <span class="p">{...</span><span class="nx">mapSelectionProps</span><span class="p">}</span><span class="sr">/</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">LayerInfo</span> <span class="p">{...</span><span class="nx">layerInfoProps</span><span class="p">}</span><span class="sr">/</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">},</span>
</code></pre></div></div>
<p>render() is simply render the map as well as MapSelection and LayerInfo.</p>

<h4 id="to-be-implemented">To be implemented</h4>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">_renderMap</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
  <span class="k">return</span> <span class="kc">null</span>
<span class="p">},</span>
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_19.jpg" alt="" /></p>

<p>Here are 4 files we need to write real code. Please open each file, and look at temporary functions which I prepared for you.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Flight layer */</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">_renderFlightOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
  <span class="k">return</span> <span class="kc">null</span>
<span class="p">}</span>
 
<span class="kd">function</span> <span class="nx">_renderFlightLayer</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[]</span>
<span class="p">}</span>
 
<span class="cm">/* Tree layer */</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">_renderTreesHeatMapOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
  <span class="k">return</span> <span class="kc">null</span>
<span class="p">}</span>
 
<span class="k">export</span> <span class="kd">function</span> <span class="nx">_renderTreesOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
  <span class="k">return</span> <span class="kc">null</span>
<span class="p">}</span>
 
<span class="cm">/* Tree heatmap layer */</span>
<span class="kd">function</span> <span class="nx">_renderTreeLayer</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Don‚Äôt worry about this too much right now. I‚Äôve covered all in next chapter üëç</p>

<h3 id="42-data-sources-structure">4.2 Data Source‚Äôs structure</h3>

<h4 id="trees-in-new-york">Trees in New York</h4>

<p>You can download <a href="https://www.kaggle.com/nycparks/tree-census">tree_new_york.csv</a><strong>¬†</strong>source from <a href="https://www.kaggle.com/nycparks/tree-census">Kaggle</a>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tree_id,block_id,borough,latitude,longitude,latin_name,common_name,location,status,health,tree_diameter,stump_diameter,root_stone,root_grate,root_other,trunk_wire,trunk_light,trunk_other,branch_light,branch_shoe,branch_other
277269,100002,Manhattan,40.70237278,-74.01143532,Metasequoia glyptostroboides,Dawn Redwood,On Curb,Alive,Fair,1,0,No,No,No,No,No,No,No,No,No
</code></pre></div></div>
<p>The size is around 80Mb, contains ~700.000 records. The structure of <strong>tree_new_york.csv</strong>¬†is really simple. But today, we should focus on <strong>latitude</strong> and <strong>longitude</strong></p>

<h4 id="flight-delay-and-cancellation">Flight Delay and Cancellation</h4>

<p>Download <a href="https://www.kaggle.com/usdot/flight-delays">flight_record.csv</a>¬†and <a href="https://www.kaggle.com/usdot/flight-delays">airport.csv</a> from Kaggle too. It‚Äôs largest file, around 192Mb zipped, 600Mb after extraction.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IATA_CODE,AIRPORT,CITY,STATE,COUNTRY,LATITUDE,LONGITUDE
ABE,Lehigh Valley International Airport,Allentown,PA,USA,40.65236,-75.44040
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>YEAR,MONTH,DAY,DAY_OF_WEEK,AIRLINE,FLIGHT_NUMBER,TAIL_NUMBER,ORIGIN_AIRPORT,DESTINATION_AIRPORT,SCHEDULED_DEPARTURE,DEPARTURE_TIME,DEPARTURE_DELAY,TAXI_OUT,WHEELS_OFF,SCHEDULED_TIME,ELAPSED_TIME,AIR_TIME,DISTANCE,WHEELS_ON,TAXI_IN,SCHEDULED_ARRIVAL,ARRIVAL_TIME,ARRIVAL_DELAY,DIVERTED,CANCELLED,CANCELLATION_REASON,AIR_SYSTEM_DELAY,SECURITY_DELAY,AIRLINE_DELAY,LATE_AIRCRAFT_DELAY,WEATHER_DELAY
2015,1,1,4,AS,98,N407AS,ANC,SEA,0005,2354,-11,21,0015,205,194,169,1448,0404,4,0430,0408,-22,0,0,,,,,,
</code></pre></div></div>
<p>In flight_record.csv, they didn‚Äôt include lat/long. So we need to write helper code to map departure/arrival airport‚Äôs coordination.</p>

<p>The valuable is departure_delay, distance, air_time field. It brings to us an important point. Useful for calculating the color of flight route (depend on how long departure_delay), velocity, and airplane position in the sky real-time (we do by GLSL later).</p>

<p>Maybe take a second to mull that over. By understanding the data structure, we could process and manipulate the data easier.</p>

<p><img src="https://i0.wp.com/koenig-media.raywenderlich.com/uploads/2016/03/iThinkIveGotThis.png" alt="" /></p>

<h3 id="43-mapbox">4.3 Mapbox</h3>

<p>The first goal we should achieve is figured out the way to present the map. According to my mention before, we use MapBox through this tutorial. Please navigate to <strong>_renderMap()</strong> in main.js, and implement below code</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">_renderMap</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">mapViewState</span><span class="p">,</span> <span class="nx">mapMode</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span>
  <span class="kd">const</span> <span class="nx">isActiveOverlay</span> <span class="o">=</span> <span class="nx">mapMode</span> <span class="o">!==</span> <span class="nx">MapMode</span><span class="p">.</span><span class="nx">NONE</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">MapboxGLMap</span>
      <span class="nx">mapboxApiAccessToken</span><span class="o">=</span><span class="p">{</span><span class="nx">MAPBOX_ACCESS_TOKEN</span><span class="p">}</span>
      <span class="nx">width</span><span class="o">=</span><span class="p">{</span><span class="nx">width</span><span class="p">}</span>
      <span class="nx">height</span><span class="o">=</span><span class="p">{</span><span class="nx">height</span><span class="p">}</span>
      <span class="nx">mapStyle</span><span class="o">=</span><span class="dl">'</span><span class="s1">mapbox://styles/mapbox/dark-v9</span><span class="dl">'</span>
      <span class="nx">perspectiveEnabled</span>
      <span class="p">{</span> <span class="p">...</span><span class="nx">mapViewState</span> <span class="p">}</span>
      <span class="nx">onChangeViewport</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">_handleViewportChanged</span><span class="p">}</span><span class="o">&gt;</span>
      <span class="p">{</span><span class="nx">isActiveOverlay</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">_renderVisualizationOverlay</span><span class="p">()}</span>
      <span class="o">&lt;</span><span class="nx">FPSStats</span> <span class="nx">isActive</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="sr">/MapboxGLMap</span><span class="err">&gt;
</span>  <span class="p">);</span>
<span class="p">},</span>
</code></pre></div></div>
<p>It‚Äôs really straight-forward, we pass width, height, mapStyle, and mapViewState into **<MapboxGLMap>**. You can get further info at [mapbox‚Äôs documentations](https://www.mapbox.com/mapbox-gl-js/api/). The important point is isActiveOverlay. It will render the VisualizationOverlay if we choice any mode from MapSelection.</MapboxGLMap></p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">_renderVisualizationOverlay</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">flightArcs</span><span class="p">,</span> <span class="nx">airports</span><span class="p">,</span> <span class="nx">mapMode</span><span class="p">,</span> <span class="nx">trees</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span>
 
  <span class="c1">// wait until data is ready before rendering</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">flightArcs</span> <span class="o">===</span> <span class="kc">null</span><span class="o">||</span> <span class="nx">airports</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">trees</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[]</span>
  <span class="p">}</span>
 
  <span class="kd">const</span> <span class="nx">param</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">props</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">,</span>
    <span class="na">state</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span>
    <span class="na">onWebGLInitialized</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_onWebGLInitialized</span><span class="p">,</span>
    <span class="na">effects</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_effects</span><span class="p">,</span>
  <span class="p">}</span>
 
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
      <span class="p">{</span> <span class="nx">mapMode</span> <span class="o">===</span> <span class="nx">MapMode</span><span class="p">.</span><span class="nx">TREES</span> <span class="o">&amp;&amp;</span> <span class="nx">_renderTreesOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">{</span> <span class="nx">mapMode</span> <span class="o">===</span> <span class="nx">MapMode</span><span class="p">.</span><span class="nx">TREES_HEATMAP</span> <span class="o">&amp;&amp;</span> <span class="nx">_renderTreesHeatMapOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">{</span> <span class="nx">mapMode</span> <span class="o">===</span> <span class="nx">MapMode</span><span class="p">.</span><span class="nx">FLIGHT</span> <span class="o">&amp;&amp;</span> <span class="nx">_renderFlightOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">}</span>
      <span class="p">{</span> <span class="nx">mapMode</span> <span class="o">===</span> <span class="nx">MapMode</span><span class="p">.</span><span class="nx">TAXI</span> <span class="o">&amp;&amp;</span> <span class="nx">_renderTaxiOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">},</span>
<span class="nx">GHT</span> <span class="o">&amp;&amp;</span> <span class="nx">_renderFlightOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">}</span> <span class="p">{</span> <span class="nx">mapMode</span> <span class="o">===</span> <span class="nx">MapMode</span><span class="p">.</span><span class="nx">TAXI</span> <span class="o">&amp;&amp;</span> <span class="nx">_renderTaxiOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">}</span> <span class="o">&lt;</span><span class="sr">/div&gt; </span><span class="se">)</span><span class="sr"> }</span><span class="err">,
</span></code></pre></div></div>
<p>I wrote it for you. It automatic switches and render individually overlay depend on mapMode we‚Äôre selecting.</p>

<p><strong>_handleViewportChanged</strong> will be triggered whenever the viewport changed, and update the viewState as well as rendering the overlay again. If we don‚Äôt re-render overlay layer with new state of map, the layers are still same old state. It‚Äôs incorrect behavior.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">_handleViewportChanged</span><span class="p">(</span><span class="nx">mapViewState</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">mapViewState</span><span class="p">.</span><span class="nx">pitch</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mapViewState</span><span class="p">.</span><span class="nx">pitch</span> <span class="o">=</span> <span class="mi">60</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">updateMap</span><span class="p">(</span><span class="nx">mapViewState</span><span class="p">))</span>
<span class="p">},</span>
</code></pre></div></div>
<h4 id="mapbox-public-token">Mapbox Public Token</h4>

<p>Don‚Äôt forget to get your Mapbox Public Token¬†from <a href="https://www.mapbox.com/studio/">Mapbox‚Äôs Dashboard</a></p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_11.jpg" alt="" /></p>

<p>Feels free to spent 5 mins for experiment <a href="https://www.mapbox.com/studio/styles/">Mapbox‚Äôs map editor</a>. It‚Äôs amazing tool, allow you to edit/modify the layout of map depends on your purpose.</p>

<h3 id="44-visualize-trees-in-new-york">4.4 Visualize trees in New York</h3>

<h4 id="parsing-tree_new_yorkcsv">Parsing tree_new_york.csv</h4>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">_loadData</span><span class="p">()</span> <span class="p">{</span>
  
  <span class="c1">// Load Tree</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_loadCsvFile</span><span class="p">(</span><span class="nx">TREE_DATA</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">loadTrees</span><span class="p">(</span><span class="nx">data</span><span class="p">))})</span>
<span class="p">},</span>
</code></pre></div></div>

<p>_loadCsvFile is helper func I wrote for you. It reads csv file and parsing into array. Then dispatching <strong>loadTrees</strong> action to ReduxStore</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="dl">'</span><span class="s1">LOAD_TREES</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">trees</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">item</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
      <span class="kd">const</span> <span class="nx">lat</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">latitude</span>
      <span class="kd">const</span> <span class="nx">long</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">longitude</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="na">position</span><span class="p">:</span> <span class="p">[</span><span class="nb">Number</span><span class="p">(</span><span class="nx">long</span><span class="p">),</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">lat</span><span class="p">)]</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="p">{...</span><span class="nx">state</span><span class="p">,</span> <span class="nx">trees</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The purpose of our tutorial is representing the distribution of tree. So we ignore unnecessary fields, we only care long/lat. It‚Äôs why I .map() to transform items into position object. Then returning the result into mainState. It‚Äôs not hard If you‚Äôre familiar with React+Redux.</p>

<h4 id="treescreengridoverlayjs">TreeScreenGridOverlay.js</h4>

<p>ScreenGridLayer is built-in Deck.gl. It‚Äôs similar with Heatmap.¬†The ScreenGridLayer takes in an array of latitude and longitude coordinate points, aggregates them into histogram bins and renders as a grid.</p>

<p>Please navigate to <strong>tree_screengrid_overlay.js</strong> in <strong>overlay</strong> folder.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">_renderTreesOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">mapViewState</span><span class="p">,</span> <span class="nx">trees</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">props</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">state</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">DeckGL</span>
        <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">default-deckgl-overlay</span><span class="dl">"</span>
        <span class="nx">width</span><span class="o">=</span><span class="p">{</span><span class="nx">width</span><span class="p">}</span>
        <span class="nx">height</span><span class="o">=</span><span class="p">{</span><span class="nx">height</span><span class="p">}</span>
        <span class="nx">debug</span>
        <span class="p">{...</span><span class="nx">mapViewState</span><span class="p">}</span>
        <span class="nx">onWebGLInitialized</span><span class="o">=</span><span class="p">{</span><span class="nx">param</span><span class="p">.</span><span class="nx">onWebGLInitialized</span><span class="p">}</span>
        <span class="nx">layers</span><span class="o">=</span><span class="p">{</span><span class="nx">_renderTreeLayer</span><span class="p">(</span><span class="nx">param</span><span class="p">.</span><span class="nx">props</span><span class="p">)}</span>
        <span class="nx">effects</span><span class="o">=</span><span class="p">{</span><span class="nx">param</span><span class="p">.</span><span class="nx">effects</span><span class="p">}</span>
      <span class="sr">/</span><span class="err">&gt;
</span>    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<p>It‚Äôs perfect time to implement <strong>_renderTreesOverlay()</strong> func. Initialize DeckGL with specific width/height. The layer‚Äôs parameter is passed from <strong>_renderTreeLayer()</strong>. Be care here. We return ScreenGridLayer associate with trees model.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">_renderTreeLayer</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">trees</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">ScreenGridLayer</span><span class="p">({</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">gird</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="nx">trees</span><span class="p">,</span>
      <span class="na">minColor</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="na">unitWidth</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
      <span class="na">unitHeight</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">})</span>
  <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="results">Results</h4>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_12.jpg" alt="" /></p>

<p>Run on terminal.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn start
</code></pre></div></div>
<p>The result works like a charm. Despite 683.788 trees, Deck.gl still handles perfectly, around 40-60 FPS.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_14.jpg" alt="" /></p>

<p>The aggregation is done in screen space, so the data prop needs to be reaggregated by the layer whenever the map is zoomed or panned. This means that this layer is best used with small data set, however, the visuals when used with the right data set can be quite effective.</p>

<p>The frame will be dropped gradually when zooming in/out, but it‚Äôs acceptable result üíØ</p>

<p>ScreenGirdLayer is perfect choose if you would like to visualize the distribution of user/object on a map. ü§ò</p>

<h3 id="45-heat-map">4.5 Heat-map</h3>

<p><a href="https://github.com/vicapow/react-map-gl-heatmap-overlay">Heatmap</a> is a graphical representation of data where the individual values contained in a¬†<a href="https://en.wikipedia.org/wiki/Matrix_(mathematics)" title="Matrix (mathematics)">matrix</a>¬†are represented as colors.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_15.jpg" alt="" /></p>

<p>It‚Äôs extremely useful to present the large data over the world.¬†There are many different¬†<a href="https://en.wikipedia.org/wiki/Color_scheme" title="Color scheme">color schemes</a>¬†that can be used to illustrate the heatmap, with perceptual advantages and disadvantages for each.</p>

<p>It‚Äôs time to bring heatmap. Come back at _renderTreesHeatMapOverlay in <strong>tree_heatmap_overlay.js</strong> and put it down.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">_renderTreesHeatMapOverlay</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">mapViewState</span><span class="p">,</span> <span class="nx">trees</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">props</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">param</span><span class="p">.</span><span class="nx">state</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">HeatmapOverlay</span>
        <span class="nx">locations</span><span class="o">=</span><span class="p">{</span><span class="nx">trees</span><span class="p">}</span>
        <span class="p">{...</span><span class="nx">mapViewState</span><span class="p">}</span>
        <span class="nx">width</span><span class="o">=</span><span class="p">{</span><span class="nx">width</span><span class="p">}</span>
        <span class="nx">height</span><span class="o">=</span><span class="p">{</span><span class="nx">height</span><span class="p">}</span>
        <span class="nx">lngLatAccessor</span><span class="o">=</span><span class="p">{(</span><span class="nx">tree</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">tree</span><span class="p">[</span><span class="dl">'</span><span class="s1">position</span><span class="dl">'</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">tree</span><span class="p">[</span><span class="dl">'</span><span class="s1">position</span><span class="dl">'</span><span class="p">][</span><span class="mi">1</span><span class="p">]]}</span>
        <span class="sr">/</span><span class="err">&gt;
</span>    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>lngLatAccessor</strong>¬†: Data accessors can be provided if your data doesn‚Äôt fit the expected form <code class="language-plaintext highlighter-rouge">{longitude, latitude}</code>.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_16.jpg" alt="" /></p>

<p>I admit react-map-gl-heat overlay handled performance for 700.00 is¬†worse.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">gradientColors</span><span class="o">=</span><span class="p">{</span><span class="nx">Immutable</span><span class="p">.</span><span class="nx">List</span><span class="p">([</span><span class="dl">'</span><span class="s1">blue</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">red</span><span class="dl">'</span><span class="p">])}</span>
</code></pre></div></div>
<p>React-map-gl-heat also provides gradientColors, you can customize your look easier. <a href="http://colorbrewer2.org/#type=sequential&amp;scheme=OrRd&amp;n=3">ColorBrewer</a> offer GUI to pick color-scheme.</p>

<h3 id="46-conclusion">¬†4.6 Conclusion</h3>

<p>In section 4, I mention two of layers which built-in Deck.gl. They also have¬†Arc Layer,¬†Choropleth Layer,¬†Line Layer,¬†Scatterplot Layer. Trying all of layers is better idea üëª</p>

<h2 id="5-flightlayer">5. FlightLayer</h2>

<h3 id="51-overall">5.1 Overall</h3>

<p>It‚Äôs time for the exciting part. We‚Äôre going to extend deck.gl‚Äôs Layer, customize it for representing Flight Route. Because of deck.gl don‚Äôt offer FlightLayer, so the one way is to implement it by our hand.</p>

<p>We‚Äôre dealing with GLSL shader, please confirmed you‚Äôre installed¬†<strong>glslify</strong> correctly. If now, please run below code.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save</span> glslify
</code></pre></div></div>
<h3 id="52-extend-deckgls-layer">5.2 Extend deck.gl‚Äôs Layer.</h3>

<p>FlightLayer is a curve from <strong>sourcePoint</strong> to <strong>tartgetPoint</strong>. As you can see the screenshot below, it‚Äôs actually <a href="https://en.wikipedia.org/wiki/Parabola">parabola</a> we‚Äôve learn in Secondary school right üòâ</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_20.jpg" alt="" /></p>

<p>Look closer. I admit it doesn‚Äôt look like flight route. Because the flight routes are extremely complexity in real-life. We assume it‚Äôs simply parabola.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_21.jpg" alt="" /></p>

<p>So the FlightLayer takes 3 parameters: <strong>sourcePosition</strong>, <strong>targetPosition</strong> as well as a <strong>color</strong>.</p>

<h3 id="53-processing-flight-record-data">5.3 Processing flight record data</h3>

<p>Before visualizing, we need to process the flight data to fit with our requirement.</p>

<p>Load flight-data.csv, airport.csv</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Load Flight Data</span>
<span class="k">this</span><span class="p">.</span><span class="nx">_loadCsvFile</span><span class="p">(</span><span class="nx">AIRPORT_DATA</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">loadAirport</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_loadCsvFile</span><span class="p">(</span><span class="nx">FLIGHT_DATA</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="nx">loadFlightDataPoints</span><span class="p">(</span><span class="nx">data</span><span class="p">))})</span>
<span class="p">});</span>
</code></pre></div></div>
<p>in reducer</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="dl">'</span><span class="s1">LOAD_FLIGHT_POINT</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">flightArcs</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">item</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="kd">const</span> <span class="nx">originalAirport</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">ORIGIN_AIRPORT</span>
    <span class="kd">const</span> <span class="nx">destinationAirport</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">DESTINATION_AIRPORT</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">sourcePosition</span><span class="p">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">airports</span><span class="p">[</span><span class="nx">originalAirport</span><span class="p">],</span>
      <span class="na">targetPosition</span><span class="p">:</span> <span class="nx">state</span><span class="p">.</span><span class="nx">airports</span><span class="p">[</span><span class="nx">destinationAirport</span><span class="p">],</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="k">return</span> <span class="p">{...</span><span class="nx">state</span><span class="p">,</span> <span class="nx">flightArcs</span><span class="p">}</span>
<span class="p">}</span>
 
<span class="k">case</span> <span class="dl">'</span><span class="s1">LOAD_AIRPORT</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">airports</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">action</span><span class="p">.</span><span class="nx">airports</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="nx">airports</span><span class="p">[</span><span class="nx">item</span><span class="p">.</span><span class="nx">IATA_CODE</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">Number</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">LONGITUDE</span><span class="p">),</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">LATITUDE</span><span class="p">)]</span>
  <span class="p">})</span>
 
  <span class="k">return</span> <span class="p">{...</span><span class="nx">state</span><span class="p">,</span> <span class="nx">airports</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Please take a notice at <strong>LOAD_AIRPORT</strong> action, I convert airport array to hash-map. Because time complexity for searching key in¬†generally is O(1). It‚Äôs really useful for <strong>LOAD_FLIGHT_POINT</strong> action, when mapping coordinate for original/destination airport.</p>

<h3 id="54-creating-custom-layer-flight-layer">5.4 Creating custom layer: Flight layer</h3>

<p><img src="https://i1.wp.com/media.giphy.com/media/d3mlE7uhX8KFgEmY/source.gif" alt="" /></p>

<p>Time for hacking your brain üòâ</p>

<h4 id="layer-life-cycle">Layer life-cycle</h4>

<p>Below is graph I summarize layer‚Äôs lifecycle.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_22.jpg" alt="" /></p>

<p>Fully documentation <a href="https://uber.github.io/deck.gl/#/documentation/creating-custom-layers/layer-lifecycle">here</a>¬†. Because of we extend from Layer, so we only override Layer.initializeState(), Layer.draw({uniform}) and¬†Layer.updateState() (optional).</p>

<ul>
  <li><strong>Layer.initializeState()</strong>: This method is called only once for each layer (as defined by the¬†id¬†property), to set up the initial state for that layer. deck.gl will already have created the¬†state¬†object at this time, and added the¬†gl¬†context and the¬†attributeManager¬†context.</li>
  <li><strong>Layer.draw({uniform})</strong>:¬†Allows a layer to ‚Äúrender‚Äù or generate one or more deck.gl Layers passing in its own state as props. The layers will be rendered after the rendering layer, but before the next layer in the list. renderLayers will be called on the new layers, allowing the decomposition of the drawing of a complex data set into ‚Äúprimitive‚Äù layers.</li>
  <li><strong>Layer.updateState()</strong>:¬†Called when a new layer has been matched with a layer from the previous render cycle (resulting in new props being passed to that layer), or when context has changed and layers are about to be drawn.</li>
</ul>

<h4 id="implement-flightlayer">Implement FlightLayer</h4>

<p>Please navigate to <strong>../scr/layers/core/flight-data/flight-data.js</strong> I prepared all for saving time ü§ó</p>

<p>in flight-data.js</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">updateState</span><span class="p">({</span><span class="nx">props</span><span class="p">,</span> <span class="na">changeFlags</span><span class="p">:</span> <span class="p">{</span><span class="nx">dataChanged</span><span class="p">}})</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
<span class="p">}</span>
 
<span class="nx">initializeState</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
<span class="p">}</span>
 
<span class="nx">draw</span><span class="p">({</span><span class="nx">uniforms</span><span class="p">})</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
<span class="p">}</span>
 
<span class="nx">_createModel</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
<span class="p">}</span>
 
<span class="nx">calculateInstanceSourcePositions</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
<span class="p">}</span>
 
<span class="nx">calculateInstanceTargetPositions</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
<span class="p">}</span>
 
<span class="nx">calculateInstanceSourceColors</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
<span class="p">}</span>
 
<span class="nx">calculateInstanceTargetColors</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Implement here</span>
<span class="p">}</span>
 
<span class="nx">getShaders</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">vs</span><span class="p">:</span> <span class="nx">readFileSync</span><span class="p">(</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">./flight-layer-vertex.glsl</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">fs</span><span class="p">:</span> <span class="nx">readFileSync</span><span class="p">(</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">./flight-layer-fragment.glsl</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
<p>All we need are here.</p>

<h4 id="create-gl-model">Create gl model</h4>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">_createModel</span><span class="p">(</span><span class="nx">gl</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">positions</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">const</span> <span class="nx">NUM_SEGMENTS</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">NUM_SEGMENTS</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">positions</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">];</span>
  <span class="p">}</span>
 
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Model</span><span class="p">({</span>
    <span class="nx">gl</span><span class="p">,</span>
    <span class="p">...</span><span class="nx">assembleShaders</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getShaders</span><span class="p">()),</span>
    <span class="na">geometry</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Geometry</span><span class="p">({</span>
      <span class="na">drawMode</span><span class="p">:</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">LINE_STRIP</span><span class="p">,</span>
      <span class="na">positions</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Float32Array</span><span class="p">(</span><span class="nx">positions</span><span class="p">)</span>
    <span class="p">}),</span>
    <span class="na">isInstanced</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
<p><strong>NUM_SEGMENTS</strong> is a number of small segment we draw parabola. The reason is, In OpenGL world, we can‚Äôt draw arc line, we need to draw each segment and line it together. As more as¬†<strong>NUM_SEGMENTS</strong> is, the flight route is more smoothly.</p>

<p>Finally, we create Model and Geometry internally, <strong>GL.LINE_STIP</strong> and position as input agreement.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">positions</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">positions</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">];</span>
</code></pre></div></div>
<p>What‚Äôs it? It‚Äôs placeholder array for representing index of segment. We passed <i> 3 times because we store vec3. It‚Äôs using in <strong>vertex.glsl</strong> to determine which index of segments üëç</i></p>

<p>Don‚Äôt forget to take a look at <strong>this.getShader()</strong>. I wrote for you. It‚Äôs simply to read shader files in same directory.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">getShaders</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">vs</span><span class="p">:</span> <span class="nx">readFileSync</span><span class="p">(</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">./flight-layer-vertex.glsl</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">),</span>
    <span class="na">fs</span><span class="p">:</span> <span class="nx">readFileSync</span><span class="p">(</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">./flight-layer-fragment.glsl</span><span class="dl">'</span><span class="p">),</span> <span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="initializestate">initializeState()</h4>

<p>initializeState() is one method you must implement to create OpenGL resource you need to render layer. Deck.gl looks for the variable <strong>model</strong> on your state, and if set expects it to be an instance of a [luma.gl] Model class.</p>

<p>So we passed model we created before to this.state. According to <a href="https://uber.github.io/deck.gl/#/documentation/creating-custom-layers/attribute-management">Deck.gl‚Äôs attributeManager recommendation</a>, we should define the attribute for vertex.glsl file.</p>

<p>We defined</p>

<ul>
  <li>instanceSourcePositions, instanceSourcePositions is <strong>[vector3]</strong> as x,y,z.</li>
  <li>instanceSourceColors,¬†instanceTargetColors is <strong>[vector4]</strong> as r,g,b,a and unsigned_byte.</li>
</ul>

<p>The complete code is below.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">initializeState</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">gl</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">model</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">_createModel</span><span class="p">(</span><span class="nx">gl</span><span class="p">)});</span>
 
  <span class="kd">const</span> <span class="p">{</span><span class="nx">attributeManager</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">;</span>
  <span class="nx">attributeManager</span><span class="p">.</span><span class="nx">addInstanced</span><span class="p">({</span>
    <span class="na">instanceSourcePositions</span><span class="p">:</span> <span class="p">{</span><span class="na">size</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">update</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculateInstanceSourcePositions</span><span class="p">},</span>
    <span class="na">instanceTargetPositions</span><span class="p">:</span> <span class="p">{</span><span class="na">size</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">update</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculateInstanceTargetPositions</span><span class="p">},</span>
    <span class="na">instanceSourceColors</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">UNSIGNED_BYTE</span><span class="p">,</span>
      <span class="na">size</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="na">update</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculateInstanceSourceColors</span>
    <span class="p">},</span>
    <span class="na">instanceTargetColors</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="nx">GL</span><span class="p">.</span><span class="nx">UNSIGNED_BYTE</span><span class="p">,</span>
      <span class="na">size</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
      <span class="na">update</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">calculateInstanceTargetColors</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="calculate-position-vec3">Calculate position vec3</h4>

<p>It‚Äôs time for implementing helper function to calculate source/target position and color as well.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">calculateInstanceSourcePositions</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">data</span><span class="p">,</span> <span class="nx">getSourcePosition</span><span class="p">,</span> <span class="nx">getTargetPosition</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">value</span><span class="p">,</span> <span class="nx">size</span><span class="p">}</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">object</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">sourcePosition</span> <span class="o">=</span> <span class="nx">getSourcePosition</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sourcePosition</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sourcePosition</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">i</span> <span class="o">+=</span> <span class="nx">size</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="nx">calculateInstanceTargetPositions</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">data</span><span class="p">,</span> <span class="nx">getSourcePosition</span><span class="p">,</span> <span class="nx">getTargetPosition</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">value</span><span class="p">,</span> <span class="nx">size</span><span class="p">}</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">object</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">targetPosition</span> <span class="o">=</span> <span class="nx">getTargetPosition</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">targetPosition</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">targetPosition</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">i</span> <span class="o">+=</span> <span class="nx">size</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>It‚Äôs not easy to understand if you‚Äôre not familiar WebGL or OpenGL in general. The main idea is to create array for each attribute (in vertex shader file)</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">sourcePosition</span> <span class="o">=</span> <span class="nx">getSourcePosition</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
<span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sourcePosition</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">sourcePosition</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div>

<p>We get source position. get longitude and latitude which stand for¬†sourcePosition[0] and¬†sourcePosition[1], then passing to value array. Please z = 0, because it‚Äôs on earth ground.</p>

<p>It‚Äôs hacky solution because we can‚Äôt pass our object from javascript directly into vertex.glsl. The common approach is using array to pass long/lat indirectly and processing those data later. Actually, we could pass struct, but at this time, I won‚Äôt mention it.</p>

<h4 id="calculate-colors-vec4">Calculate colors vec4</h4>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">calculateInstanceSourceColors</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">data</span><span class="p">,</span> <span class="nx">getSourceColor</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">value</span><span class="p">,</span> <span class="nx">size</span><span class="p">}</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">object</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">getSourceColor</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">||</span> <span class="nx">DEFAULT_COLOR</span><span class="p">;</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">?</span> <span class="nx">DEFAULT_COLOR</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">:</span> <span class="nx">color</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="nx">i</span> <span class="o">+=</span> <span class="nx">size</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="nx">calculateInstanceTargetColors</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">data</span><span class="p">,</span> <span class="nx">getTargetColor</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">value</span><span class="p">,</span> <span class="nx">size</span><span class="p">}</span> <span class="o">=</span> <span class="nx">attribute</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">object</span> <span class="k">of</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">getTargetColor</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="o">||</span> <span class="nx">DEFAULT_COLOR</span><span class="p">;</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">color</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="nx">value</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">?</span> <span class="nx">DEFAULT_COLOR</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">:</span> <span class="nx">color</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="nx">i</span> <span class="o">+=</span> <span class="nx">size</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>We do same philosophy with color as well.</p>

<h4 id="layerdraw">Layer.draw()</h4>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">draw</span><span class="p">({</span><span class="nx">uniforms</span><span class="p">})</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">gl</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">{</span><span class="nx">trailLength</span><span class="p">,</span> <span class="nx">currentTime</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">currentTime</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">uniforms</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">trailLength</span><span class="p">,</span>
    <span class="nx">currentTime</span><span class="p">,</span>
    <span class="nx">timestamp</span>
  <span class="p">}));</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Draw layer and passing our data uniform into shader file is self-explanatory. We also pass trailLength, currentTime, timestamp as uniform too. We will use it later, for animation ü§ó</p>

<h3 id="55glsl-opengl-shading-language">5.5¬†GLSL (OpenGL Shading Language)</h3>

<p>If you don‚Äôt have basic knowledge about GLSL, feels free to skip this section.</p>

<p>GLSLis a high-level shading language with a syntax based on the C programming language. Give developers more direct control of the graphics pipeline without having to use ARB assembly language or hardware-specific languages.</p>

<h4 id="flight-layer-vertexglsl">flight-layer-vertex.glsl</h4>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="nx">define</span> <span class="nx">SHADER_NAME</span> <span class="nx">flight</span><span class="o">-</span><span class="nx">layer</span><span class="o">-</span><span class="nx">vertex</span><span class="o">-</span><span class="nx">shader</span>
 
<span class="kd">const</span> <span class="nx">float</span> <span class="nx">N</span> <span class="o">=</span> <span class="mf">49.0</span><span class="p">;</span>
 
<span class="nx">attribute</span> <span class="nx">vec3</span> <span class="nx">positions</span><span class="p">;</span>
<span class="nx">attribute</span> <span class="nx">vec4</span> <span class="nx">instanceSourceColors</span><span class="p">;</span>
<span class="nx">attribute</span> <span class="nx">vec4</span> <span class="nx">instanceTargetColors</span><span class="p">;</span>
<span class="nx">attribute</span> <span class="nx">vec3</span> <span class="nx">instanceSourcePositions</span><span class="p">;</span>
<span class="nx">attribute</span> <span class="nx">vec3</span> <span class="nx">instanceTargetPositions</span><span class="p">;</span>
<span class="nx">attribute</span> <span class="nx">vec3</span> <span class="nx">instancePickingColors</span><span class="p">;</span>
 
<span class="nx">uniform</span> <span class="nx">float</span> <span class="nx">opacity</span><span class="p">;</span>
<span class="nx">uniform</span> <span class="nx">float</span> <span class="nx">renderPickingBuffer</span><span class="p">;</span>
<span class="nx">uniform</span> <span class="nx">float</span> <span class="nx">currentTime</span><span class="p">;</span>
<span class="nx">uniform</span> <span class="nx">float</span> <span class="nx">trailLength</span><span class="p">;</span>
<span class="nx">uniform</span> <span class="nx">float</span> <span class="nx">timestamp</span><span class="p">;</span>
 
<span class="nx">varying</span> <span class="nx">float</span> <span class="nx">vTime</span><span class="p">;</span>
<span class="nx">varying</span> <span class="nx">vec4</span> <span class="nx">vColor</span><span class="p">;</span>
 
 
<span class="nx">float</span> <span class="nx">paraboloid</span><span class="p">(</span><span class="nx">vec2</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">vec2</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">float</span> <span class="nx">ratio</span><span class="p">)</span> <span class="p">{</span>
 
  <span class="nx">vec2</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">mix</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">ratio</span><span class="p">);</span>
  <span class="nx">vec2</span> <span class="nx">center</span> <span class="o">=</span> <span class="nx">mix</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
 
  <span class="nx">float</span> <span class="nx">dSourceCenter</span> <span class="o">=</span> <span class="nx">distance</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">center</span><span class="p">);</span>
  <span class="nx">float</span> <span class="nx">dXCenter</span> <span class="o">=</span> <span class="nx">distance</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">center</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">dSourceCenter</span> <span class="o">+</span> <span class="nx">dXCenter</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">dSourceCenter</span> <span class="o">-</span> <span class="nx">dXCenter</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="k">void</span> <span class="nx">main</span><span class="p">(</span><span class="k">void</span><span class="p">)</span> <span class="p">{</span>
 
  <span class="c1">// 1</span>
  <span class="nx">vec2</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">preproject</span><span class="p">(</span><span class="nx">instanceSourcePositions</span><span class="p">.</span><span class="nx">xy</span><span class="p">);</span>
  <span class="nx">vec2</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">preproject</span><span class="p">(</span><span class="nx">instanceTargetPositions</span><span class="p">.</span><span class="nx">xy</span><span class="p">);</span>
  
  <span class="c1">// 2</span>
  <span class="nx">float</span> <span class="nx">segmentRatio</span> <span class="o">=</span> <span class="nx">smoothstep</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nx">positions</span><span class="p">.</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">N</span><span class="p">);</span>
 
  <span class="c1">// 3</span>
  <span class="nx">float</span> <span class="nx">vertex_height</span> <span class="o">=</span> <span class="nx">paraboloid</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">segmentRatio</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">vertex_height</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="nx">vertex_height</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="nx">vec3</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">vec3</span><span class="p">(</span>
    <span class="c1">// xy: linear interpolation of source &amp; target</span>
    <span class="nx">mix</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">segmentRatio</span><span class="p">),</span>
    <span class="c1">// z: paraboloid interpolate of source &amp; target</span>
    <span class="nx">sqrt</span><span class="p">(</span><span class="nx">vertex_height</span><span class="p">)</span>
  <span class="p">);</span>
 
  <span class="c1">// 4</span>
  <span class="c1">// the magic de-flickering factor</span>
  <span class="nx">float</span> <span class="nx">_timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">positions</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="mf">15.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2000.0</span><span class="p">;</span>
  <span class="nx">vec4</span> <span class="nx">shift</span> <span class="o">=</span> <span class="nx">vec4</span><span class="p">(</span><span class="mi">0</span><span class="p">.,</span> <span class="mi">0</span><span class="p">.,</span> <span class="nx">mod</span><span class="p">(</span><span class="nx">_timestamp</span><span class="p">,</span> <span class="nx">trailLength</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">.);</span>
  <span class="nx">gl_Position</span> <span class="o">=</span> <span class="nx">project</span><span class="p">(</span><span class="nx">vec4</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="nx">shift</span><span class="p">;</span>
 
  <span class="c1">// Color</span>
  <span class="nx">vColor</span> <span class="o">=</span> <span class="nx">mix</span><span class="p">(</span><span class="nx">instanceSourceColors</span><span class="p">,</span> <span class="nx">instanceTargetColors</span><span class="p">,</span> <span class="nx">segmentRatio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">255</span><span class="p">.;</span>
 
  <span class="c1">// 5</span>
  <span class="nx">vTime</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="nx">currentTime</span> <span class="o">-</span> <span class="nx">_timestamp</span><span class="p">)</span> <span class="o">/</span> <span class="nx">trailLength</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<ol>
  <li><a href="https://uber.github.io/deck.gl/#/documentation/advanced-topics/coordinate-systems">preproject</a><strong>:¬†</strong>All positions must be passed through the¬†preproject¬†function (available both in JavaScript and GLSL) to convert non-linear web-mercator coordinates to linear Mercator ‚Äúworld‚Äù or ‚Äúpixel‚Äù coordinates, that can be passed to the projection matrix. At this time, we convert long/lat coordinate to pixel in our webview.</li>
  <li><a href="https://www.khronos.org/registry/OpenGL-Refpages/gl4/html/smoothstep.xhtml">smoothstep</a>¬†is built-in method in OpenGL.¬†perform Hermite interpolation between two values. The segmentRatio depends on index of segment. So it‚Äôs perfect time to get value from <strong>positions</strong> we created before.</li>
  <li>We implement paraboloid to calculate the height of parabola.</li>
</ol>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_25.jpg" alt="" /></p>

<p>Illustration each segment in parabola curve</p>

<ol>
  <li>
    <p>Calculate the shift depend on currentTime, then passing to gl_Position.</p>
  </li>
  <li>
    <p>vTime is varying variable will pass to fragment file. We calculate the time has been passed.</p>
  </li>
</ol>

<h4 id="gllinewidth-problem">glLineWidth problem</h4>

<p>Do you notice the width of flightLayer is too slim? I tried to put <strong>gl.widthLine(100)</strong> in draw() func. It didn‚Äôt work unfortunately. It takes me few hours to understand why <strong>gl.lineWidth</strong> didn‚Äôt work. Here is <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/lineWidth">problem</a>.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_23.jpg" alt="" /></p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_24.jpg" alt="" /></p>

<p>We have backup plan to implement the width line, by drawing a rectangle with height is width line. I won‚Äôt cover it.</p>

<h4 id="flight-layer-fragmentglsl">flight-layer-fragment.glsl</h4>

<p>After finished vertex.glsh, we should move to fragment. The fragment is essential file, the main purpose is handling all color mapping for each vertex.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#</span><span class="nx">define</span> <span class="nx">SHADER_NAME</span> <span class="nx">flight</span><span class="o">-</span><span class="nx">layer</span><span class="o">-</span><span class="nx">fragment</span><span class="o">-</span><span class="nx">shader</span>
 
<span class="err">#</span><span class="nx">ifdef</span> <span class="nx">GL_ES</span>
<span class="nx">precision</span> <span class="nx">highp</span> <span class="nx">float</span><span class="p">;</span>
<span class="err">#</span><span class="nx">endif</span>
 
<span class="nx">varying</span> <span class="nx">float</span> <span class="nx">vTime</span><span class="p">;</span>
<span class="nx">varying</span> <span class="nx">vec4</span> <span class="nx">vColor</span><span class="p">;</span>
 
<span class="k">void</span> <span class="nx">main</span><span class="p">(</span><span class="k">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">vTime</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="o">||</span> <span class="nx">vTime</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">discard</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">gl_FragColor</span> <span class="o">=</span> <span class="nx">vec4</span><span class="p">(</span><span class="nx">vColor</span><span class="p">.</span><span class="nx">rgb</span><span class="p">,</span> <span class="nx">vColor</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">vTime</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Please notice, vTime is passed from vertex.glsl. At this time, we will turn it by mutipling with color‚Äôs alpha.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/deck.gl_27.jpg" alt="" /></p>

<p>Look cool right? üòç</p>

<h4 id="tween-timer">Tween timer</h4>

<p>If you try running example at this time, you only see the fully parabola over the map. Now we‚Äôre adding timer to achieve animation. Navigate to startTweenTimer() in main.js</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">startTweenTimer</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_tween</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TWEEN</span><span class="p">.</span><span class="nx">Tween</span><span class="p">({</span><span class="na">time</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">to</span><span class="p">({</span><span class="na">time</span><span class="p">:</span> <span class="mi">3600</span><span class="p">},</span> <span class="mi">120000</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">onUpdate</span><span class="p">((</span><span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
            <span class="na">time</span><span class="p">:</span> <span class="nx">data</span>
          <span class="p">})</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="kc">Infinity</span><span class="p">).</span><span class="nx">start</span><span class="p">()</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">animate</span><span class="p">()</span>
<span class="p">},</span>
 
<span class="nx">animate</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">animate</span><span class="p">)</span>
  <span class="nx">TWEEN</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
<span class="p">},</span>
</code></pre></div></div>
<p>then</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>componentWillReceiveProps: function(nextProps) {
  const { mapMode } = this.props
  const { isStartedTimer } = this.state
 
  if ((nextProps.mapMode === MapMode.FLIGHT || nextProps.mapMode === MapMode.TAXI ) &amp;&amp;
      nextProps.mapMode !== mapMode &amp;&amp; isStartedTimer === false) {
    this.startTweenTimer()
    this.setState({
      isStartedTimer: true
    })
  }
},
</code></pre></div></div>
<p>It triggers tweenTimer automatically whenever we select new mapMode. I also have if condition to prevent duplicated fired.</p>

<h4 id="one-more-thing">One more thing</h4>

<p>Notify attributeManager in flight-layer.js to invalidate all vertex, and re-render with new currentTime attribute.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">updateState</span><span class="p">({</span><span class="nx">props</span><span class="p">,</span> <span class="na">changeFlags</span><span class="p">:</span> <span class="p">{</span><span class="nx">dataChanged</span><span class="p">}})</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">dataChanged</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">attributeManager</span><span class="p">.</span><span class="nx">invalidateAll</span><span class="p">();</span>
   <span class="p">}</span>
 <span class="p">}</span>

</code></pre></div></div>
<h3 id="56-finally">5.6 Finally</h3>

<p>Time for going back to terminal and type holy spell.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># To make sure you've installed packages correctly </span>
yarn <span class="nb">install 
</span>yarn start
</code></pre></div></div>

<iframe width="560" height="315" src="https://www.youtube.com/watch?v=kgcJ0rftIUA" frameborder="0" allowfullscreen=""></iframe>

<p>Feels free to switch between each map mode. I belive you will be impressed what we‚Äôve done üíØ</p>

<h2 id="6-source-code">6. Source code</h2>

<p>I published all source in my github account. Feels free to clone and create contribution if you have any great idea üòâ</p>

<p><a href="https://github.com/NghiaTranUIT/data-visualization-deck-gl">Data Visualization ‚Äì Github</a></p>

<h2 id="7-what-things-are-we-forgetting">7. What things are we forgetting?</h2>

<p>If you have bright eyes, you might notice that all flights were flew and land at destination airport at the same time, whatever the distance of airport is far away or near. It looks unreal, right? ü§î</p>

<p>Yeah, I did it on my purpose, it‚Äôs time for your experiment, your exercise ü§ó</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Given flight_data.csv with air_time field. Assumption the velecity of airplain is 999km/h.
How do we improve flight-layer-vertex.glsl to simulate it ?
 
// Hint: Take a look at
// vec4 shift = vec4(0., 0., mod(_timestamp, trailLength) * 1e-4, 0.).
// It's all you need üëç
</code></pre></div></div>

<h2 id="8-wheres-go-from-now">8. Where‚Äôs go from now?</h2>

<p>If you like and have impression how we visualize the huge data into the map. Don‚Äôt be hostile to take a look at <a href="http://deck.gl">Deck.gl</a>. Pick your favorite data at Kaggle.</p>

<p>Learning and understanding GLSL is really useful if you want to take directly to GPU.</p>

<p>Hope you have greate¬†time to ignite your lazy brain ¬†üëª</p>

:ET