I"à+<p>Hi, it‚Äôs part 2 of my LCS series. Hope you have a great day üòá</p>

<p>In this blog, I would like to cover how we can apply LCS (aka. Diff) into iOS Development. It‚Äôs so boring if I¬†keep writing blog with ‚Äúdeep‚Äù theory, and no place for enjoying.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/02/98b322c7bf5992110646420866f72f492bc8706eb4769179676149ad713251d3.jpg" alt="" /></p>

<p>Before diving, we should try a real problem I ensure everybody will encounter if you‚Äôre iOS¬†S.E.</p>

<p>Let imagine, we have an app, same philosophy with Instagram. We have Feed screen, where we can see all post of your friends, your following.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/diff_screenshot_app.jpg" alt="" /></p>

<p>On the top-right¬†of navigation bar. We have pull-to-refresh button. Whenever you tap it. It will get new data from server, then filling data into UITableView.</p>

<p>Your requirement is figured it out the way to ‚Äúreload‚Äù table view with <strong>less effort</strong> as much as <strong>possible</strong>. üòâ</p>

<h3 id="solution-1-force-reloaddata">Solution 1: Force reloadData()</h3>

<p>Don‚Äôt care any things, just call</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
</code></pre></div></div>
<p>In particular scenario, it might be the best solution if you have &lt; 10 items, and the hierarchy¬†of cell‚Äôs¬†subviews are¬†simple. But what if your app grows up quickly, and have around 100 items, each TableViewRow¬†has tons of complex subviews, such as UIStackView, UICollectionView,‚Ä¶</p>

<p>By forcing <strong>reloadData</strong>(). It means UITableView will re-draw and calculate dynamic size of 100 cells again -&gt; It hits your CPU and reduces performance as well. It‚Äôs painful.</p>

<p>I will more detail in Benchmark section to show you how it‚Äôs bad.</p>

<h3 id="solution-2-do-manually">Solution 2: Do manually</h3>

<p>Many people will come up with solution 2. Instead of calling reloadData(). They will calculate the difference (insert/delete/reload) <strong>manually</strong>¬†and warp into tableView.performAction{}</p>

<p>Some things like this</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Prepare data</span>
<span class="k">let</span> <span class="nv">oldData</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">data</span>
<span class="k">let</span> <span class="nv">newData</span> <span class="o">=</span> <span class="n">feedResponse</span><span class="o">.</span><span class="n">data</span>
 
<span class="c1">// Check diff manually</span>
<span class="c1">// How do it if the order of newData is completely difference with oldData ? ‚ùå</span>
<span class="k">let</span> <span class="nv">insertIndexPaths</span> <span class="o">=</span> <span class="c1">// If-then stuff</span>
<span class="k">let</span> <span class="nv">deleteIndexPaths</span> <span class="o">=</span> <span class="c1">// if-then stuff</span>
 
<span class="c1">// Reload</span>
<span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">beginUpdates</span><span class="p">()</span>
 
<span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">insertRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">insertIndexPaths</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="k">none</span><span class="p">)</span>
<span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">deleteIndexPaths</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="k">none</span><span class="p">)</span>
 
<span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">endUpdates</span><span class="p">()</span>
</code></pre></div></div>
<h4 id="pros">Pros</h4>

<ul>
  <li>By calling reload/insert/delete on particular cell. You reduces time to re-draw cell. It‚Äôs good point.</li>
  <li>You can apply specific animation for each kind of transform easily.</li>
</ul>

<h4 id="cons">Cons</h4>

<ul>
  <li>By calculating the diff manually, it means by your hand and brain. It‚Äôs still a nightmare if you have a many new item, and the order of new item is completely difference than previous items.</li>
  <li>If you have enough patient, and careful. You could do it, but who know your solution is the best optimization? Maybe there is someone out there who¬†come up with another comparison, have less ‚Äútransform‚Äù than your result? ü§î Working manually is not optimize approach.</li>
  <li>If you make a mistake, your app crash¬†with some kind of error like this</li>
</ul>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/02/lcs-part-2-error.jpg" alt="" /></p>

<p>It always happens you indexPaths doesn‚Äôt match with data source.</p>

<h3 id="solution-3-diff-algorithm">Solution 3: Diff Algorithm</h3>

<p>How about LCS (Diff). Good news, we can reuse what we actually¬†did on <a href="http://nghiatran.me/longest-common-subsequence-diff-part-1/">LCS Part 1</a>. By using modified Diff algorithm, we can extract ‚Äútransform‚Äù from memorization table. We can know which items are removed,¬†added, or reloaded. All of messy tasks will compute automatically. You don‚Äôt need put more effort, or get nervous when app crashes anymore.</p>

<p>The final result.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Calculate diff and map to each actions</span>
<span class="c1">// Does automatically üíØ</span>
<span class="k">let</span> <span class="nv">insertionIndexPaths</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">insertions</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="nv">$0</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">sectionIndex</span><span class="p">)</span> <span class="p">})</span>
<span class="k">let</span> <span class="nv">deletionIndexPaths</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">deletions</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="nv">$0</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">sectionIndex</span><span class="p">)</span> <span class="p">})</span>
 
<span class="c1">// Perform action</span>
<span class="n">tableView</span><span class="o">.</span><span class="nf">beginUpdates</span><span class="p">()</span>
<span class="n">tableView</span><span class="o">.</span><span class="nf">insertRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">insertionIndexPaths</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">insertionAnimation</span><span class="p">)</span>
<span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">deletionIndexPaths</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">deletionAnimation</span><span class="p">)</span>
<span class="n">tableView</span><span class="o">.</span><span class="nf">endUpdates</span><span class="p">()</span>
</code></pre></div></div>

<p>Those codes are self-explanatory, sound interesting enough? üòç</p>

<p>Besides that, I will do benchmark by¬†each solution on my old iPhone 5, give you overall perspective.</p>

<h2 id="1diff-algorithm">1.¬†Diff Algorithm</h2>

<h3 id="11-memorization-table">1.1 Memorization table</h3>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/02/table_12.png" alt="" /></p>

<p>If you‚Äôre not familiar with that memorization-table. I would like to recommend to read¬†<a href="http://nghiatran.me/longest-common-subsequence-diff-part-1/">LCS-Diff Part 1</a>¬†before going next.</p>

<p>Let me remind in case you‚Äôve forgotten. LCS is one of classic computer science problems.</p>

<p>Given string A = ADFGT, string B = AFOXT.¬†The LCS of A and B is <strong>AFT</strong>.</p>

<p>But we need more than LCS, we should need ‚Äúhow‚Äù A can transform into B. Fortunately, from the table above, we can ‚Äúextract‚Äù transform easily too. Memorization-Table is a new King üòé</p>

<h3 id="12-difftransform-enum">1.2 DiffTransform enum</h3>

<p>To understand what‚Äôs is transform stand for, I will create new generic enum</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Transform</span>
<span class="kd">enum</span> <span class="kt">DiffTransform</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="p">{</span>
    
    <span class="c1">// Represent for reload/insert/delete in tableView</span>
    <span class="c1">// Int: index need to be transform</span>
    <span class="c1">// T: generic data</span>
    <span class="k">case</span> <span class="nf">reload</span><span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">T</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">insert</span><span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">T</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">delete</span><span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">T</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We created DiffTransform enum for representing a ‚Äútransform‚Äù. Please notice one thing, I prefer use Enum with <strong>Generic</strong> and <strong>associated-value</strong> than struct/class. Because if we come with Struct/Class, we also need to define another Enum to handle kind of Transform. It‚Äôs duplicated work.</p>

<p>With DiffTransform, we can store ‚Äúkind of transform‚Äù, the index, and the real data at the same¬†object, with less code as possible üòâ</p>

<p>In few¬†trivial programming language like Java or objc, it‚Äôs impossible unfortunately. We must create class and enum, but from¬†Swift 2.0, we can do it. It‚Äôs save me a lot of redundancy code. Less code, less bug. You know ü§òüèΩ</p>

<p>In case it‚Äôs first time you‚Äôve heard it. Take a look at <a href="https://appventure.me/2015/10/17/advanced-practical-enum-examples/#sec-2-3">Generic Enum</a>¬†and <a href="https://appventure.me/2015/10/17/advanced-practical-enum-examples/#sec-1-5">Enum with associated-value</a></p>

<p>I also implement¬†few helper to quick access data in future.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Helper</span>
<span class="kd">extension</span> <span class="kt">DiffTransform</span><span class="p">:</span> <span class="kt">CustomStringConvertible</span><span class="p">,</span> <span class="kt">CustomDebugStringConvertible</span> <span class="p">{</span>
    
    <span class="c1">// Value - quick access</span>
    <span class="k">var</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">reload</span><span class="p">(</span> <span class="n">_</span><span class="p">,</span> <span class="k">let</span> <span class="nv">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">insert</span><span class="p">(</span> <span class="n">_</span><span class="p">,</span> <span class="k">let</span> <span class="nv">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">delete</span><span class="p">(</span> <span class="n">_</span><span class="p">,</span> <span class="k">let</span> <span class="nv">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// index - quick access</span>
    <span class="k">var</span> <span class="nv">index</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">reload</span><span class="p">(</span><span class="k">let</span> <span class="nv">index</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">index</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="k">let</span> <span class="nv">index</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">index</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="k">let</span> <span class="nv">index</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">index</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// CustomStringConvertible</span>
    <span class="k">var</span> <span class="nv">description</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">toString</span>
    <span class="p">}</span>
    
    <span class="c1">// CustomDebugStringConvertible</span>
    <span class="k">var</span> <span class="nv">debugDescription</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">toString</span>
    <span class="p">}</span>
    
    <span class="c1">// [Private] To string</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">toString</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="k">self</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">reload</span><span class="p">(</span><span class="k">let</span> <span class="nv">index</span><span class="p">,</span> <span class="k">let</span> <span class="nv">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">"Reload((</span><span class="se">\(</span><span class="n">index</span><span class="se">)</span><span class="s">)[</span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">])"</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="k">let</span> <span class="nv">index</span><span class="p">,</span> <span class="k">let</span> <span class="nv">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">"Insert((</span><span class="se">\(</span><span class="n">index</span><span class="se">)</span><span class="s">)[</span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">])"</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="k">let</span> <span class="nv">index</span><span class="p">,</span> <span class="k">let</span> <span class="nv">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">"Delete((</span><span class="se">\(</span><span class="n">index</span><span class="se">)</span><span class="s">)[</span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">])"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>From previous¬†LCS blog, we have 3 rules. I will remind in each step, also make a sightly modification.</p>

<p>We will traceback¬†from right-bottom corner to left-top corner.</p>

<ul>
  <li>If A[i] == B[j] -&gt;It means, A[i] is part of LCS. Then we move¬†diagonal by i‚Äì, j‚Äì</li>
</ul>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/02/table_9.png" alt="" /></p>

<p><strong>T</strong> from string A convert to <strong>T</strong> from string B -&gt; There is no difference, we just reload it.</p>

<p>The ‚Äútransform‚Äù simple is</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">reload</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">reload</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kt">A</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>

<ul>
  <li>if A[i] != B[i], we have two sub-case</li>
</ul>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span>
    <span class="c1">// Go top</span>
    <span class="c1">// Delete at i-1</span>
<span class="p">}</span>
<span class="k">else</span> <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
    <span class="c1">// Go Left</span>
    <span class="c1">// Insert at j-1</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/02/table_10.png" alt="" /></p>

<p>As you can see, G != X. It means,¬†G¬†needs to be removed from A.</p>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">delete</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">A</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/02/table_11.png" alt="" /></p>

<p>F != X. It means, X need to be added.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">insert</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">B</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- i == 0 || j ==0
</code></pre></div></div>

<p>It‚Äôs two special case we should mention. Because we need to figure it out the transform, don‚Äôt miss this case</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="c1">// Insert at j-1</span>
    <span class="k">let</span> <span class="nv">insert</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">B</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="p">}</span>
<span class="k">else</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="c1">// Remove at i-1</span>
    <span class="k">let</span> <span class="nv">remove</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">A</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="summary">Summary</h4>

<p>By following 4 cases, we can determine when transform is applied.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/02/lcs-part-2-1.png" alt="" /></p>

<p>Here is final instruction.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">reload</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">reload</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="kt">A</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="c1">// at (i,j) = (5,5)</span>
<span class="k">let</span> <span class="nv">delete</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kt">A</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">// at (4,4)</span>
<span class="k">let</span> <span class="nv">insert</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kt">B</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="c1">// at (3,4)</span>
<span class="k">let</span> <span class="nv">insert</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kt">B</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">// at (3,3)</span>
<span class="k">let</span> <span class="nv">reload</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">reload</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="kt">A</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c1">// at (3,2)</span>
<span class="k">let</span> <span class="nv">delete</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kt">A</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1">// at (2,1)</span>
<span class="k">let</span> <span class="nv">reload</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">reload</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kt">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">// at (1,1)</span>
<span class="c1">// Stop recursive at (0,0)</span>
</code></pre></div></div>

<h3 id="13-diff">1.3 Diff</h3>

<p>This time to implement the container for storing all DiffTransforms which we calculated by hand üòâ</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Diff Container</span>
<span class="kd">struct</span> <span class="kt">Diff</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="p">{</span>
    
    <span class="c1">// Shortcut Element</span>
    <span class="kd">typealias</span> <span class="kt">Element</span> <span class="o">=</span> <span class="kt">DiffTransform</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span>
    
    <span class="c1">// Result</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_result</span><span class="p">:</span> <span class="p">[</span><span class="kt">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">var</span> <span class="nv">result</span><span class="p">:</span> <span class="p">[</span><span class="kt">Element</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">_result</span>
    <span class="p">}</span>
    
    <span class="c1">// Insertion</span>
    <span class="k">var</span> <span class="nv">insertion</span><span class="p">:</span> <span class="p">[</span><span class="kt">Element</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">isInsertion</span> <span class="p">})</span>
    <span class="p">}</span>
    
    <span class="c1">// Deletion</span>
    <span class="k">var</span> <span class="nv">deletion</span><span class="p">:</span> <span class="p">[</span><span class="kt">Element</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">isDeletion</span> <span class="p">})</span>
    <span class="p">}</span>
    
    <span class="c1">// Reload</span>
    <span class="k">var</span> <span class="nv">reload</span><span class="p">:</span> <span class="p">[</span><span class="kt">Element</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="nf">filter</span><span class="p">({</span> <span class="nv">$0</span><span class="o">.</span><span class="n">isReload</span> <span class="p">})</span>
    <span class="p">}</span>
    
    <span class="k">mutating</span> <span class="kd">func</span> <span class="nf">append</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="kt">Element</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// Override + : Diff + DiffTransform</span>
<span class="kd">func</span> <span class="o">+&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="p">(</span> <span class="nv">left</span><span class="p">:</span> <span class="kt">Diff</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nv">right</span><span class="p">:</span> <span class="kt">DiffTransform</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Diff</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">left</span> <span class="o">=</span> <span class="n">left</span>
    <span class="n">left</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="n">right</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">left</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A Diff is a simple struct. It contains array of DiffTransform. I prefer to use Generic all time as possible. I suppose it‚Äôs hard to read at the first time, but if you‚Äôre familiar enough, it‚Äôs quite simple. Generic is really flexible for container as well.</p>

<p>I defined Diff<T> and DiffTransform<T> is same Generic on purpose. So both of model store same kind of value.</T></T></p>

<p>Beside that, I also implement few helper methods, it helps us get insertion/deletion/reload quickly, and override + operation too.</p>

<h3 id="14-warp-it-up">1.4 Warp it up</h3>

<p>Time to combine all separately things into one part. I‚Äôm still following same approach from Part 1, extend Array, generate MemorizationTable, recursive the table and calculate the DiffTransform.</p>

<h4 id="memorization-table">Memorization table</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Memorization table</span>
<span class="kd">struct</span> <span class="kt">MemorizationTable</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Equatable</span><span class="o">&gt;</span> <span class="p">{</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">buildTable</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="p">[</span><span class="kt">T</span><span class="p">],</span> <span class="nv">y</span><span class="p">:</span> <span class="p">[</span><span class="kt">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[[</span><span class="kt">Int</span><span class="p">]]</span> <span class="p">{</span>
        
        <span class="c1">// Create 2-dimension table, and filled with zero</span>
        <span class="k">let</span> <span class="nv">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">count</span>
        <span class="k">let</span> <span class="nv">m</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">count</span>
        <span class="k">var</span> <span class="nv">table</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="kt">Array</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nv">count</span><span class="p">:</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
        <span class="c1">// Iterate from top-left corner -&gt; bottom-right corner</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">...</span><span class="n">n</span> <span class="p">{</span>
            <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">0</span><span class="o">...</span><span class="n">m</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span> <span class="c1">// MATCH</span>
                    <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span> <span class="c1">// NOT MATCH</span>
                    <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="n">table</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="calculate-difftransfrom-diff">Calculate DiffTransfrom, Diff</h4>
<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// But we must ensure, each element must adopt with &lt;Equatable&gt; protocol -&gt; We can make comparision</span>
<span class="kd">extension</span> <span class="kt">Array</span> <span class="k">where</span> <span class="kt">Element</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
    
    <span class="kd">func</span> <span class="nf">diff</span><span class="p">(</span><span class="n">_</span> <span class="nv">other</span><span class="p">:</span> <span class="p">[</span><span class="kt">Element</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">Diff</span><span class="o">&lt;</span><span class="kt">Element</span><span class="o">&gt;</span> <span class="p">{</span>
        
        <span class="c1">// Build memorization table</span>
        <span class="k">let</span> <span class="nv">table</span> <span class="o">=</span> <span class="kt">MemorizationTable</span><span class="o">.</span><span class="nf">buildTable</span><span class="p">(</span><span class="nv">x</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">y</span><span class="p">:</span> <span class="n">other</span><span class="p">)</span>
        
        <span class="c1">// Print Diff</span>
        <span class="k">return</span> <span class="kt">Array</span><span class="o">.</span><span class="nf">diffFromMemorizationTable</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="k">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="k">self</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">fileprivate</span> <span class="kd">static</span> <span class="kd">func</span> <span class="nf">diffFromMemorizationTable</span><span class="p">(</span><span class="n">_</span> <span class="nv">table</span><span class="p">:</span> <span class="p">[[</span><span class="kt">Int</span><span class="p">]],</span> <span class="n">_</span> <span class="nv">x</span><span class="p">:</span> <span class="p">[</span><span class="kt">Element</span><span class="p">],</span> <span class="n">_</span> <span class="nv">y</span><span class="p">:</span> <span class="p">[</span><span class="kt">Element</span><span class="p">],</span> <span class="n">_</span> <span class="nv">i</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="n">_</span> <span class="nv">j</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Diff</span><span class="o">&lt;</span><span class="kt">Element</span><span class="o">&gt;</span> <span class="p">{</span>
        
        <span class="c1">// Exit</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">Diff</span><span class="o">&lt;</span><span class="kt">Element</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// Insert</span>
            <span class="k">return</span> <span class="nf">diffFromMemorizationTable</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// Delete</span>
            <span class="k">return</span> <span class="nf">diffFromMemorizationTable</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="p">{</span> <span class="c1">// Delete</span>
            <span class="k">return</span> <span class="nf">diffFromMemorizationTable</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span> <span class="c1">// Insert</span>
            <span class="k">return</span> <span class="nf">diffFromMemorizationTable</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span> <span class="c1">// Reload</span>
            <span class="k">return</span> <span class="nf">diffFromMemorizationTable</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="kt">DiffTransform</span><span class="o">.</span><span class="nf">reload</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It‚Äôs sightly modification than the original LCS Algorithm. Instead of trace-back and print LCS string, we check small case and determine when ‚ÄúTransform‚Äù and warp into DiffTransform.</p>

<p>The heart of Diff¬†is at¬†<strong>diffFromMemorizationTable¬†</strong>func. It‚Äôs recursion method, and base-recursion return Diff(), then adding DiffTransform from prior recursive func. The finally result will be an Diff instance, with result is all transforms.</p>

<h4 id="apply-diff">Apply Diff</h4>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Apply Diff </span>
<span class="kd">func</span> <span class="nf">apply</span><span class="p">(</span><span class="nv">diff</span><span class="p">:</span> <span class="kt">Diff</span><span class="o">&lt;</span><span class="kt">Element</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">Element</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">copy</span> <span class="o">=</span> <span class="k">self</span>
    
    <span class="c1">// Delete first</span>
    <span class="k">for</span> <span class="n">delete</span> <span class="k">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">deletion</span> <span class="p">{</span>
        <span class="n">copy</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">delete</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">// Insert</span>
    <span class="k">for</span> <span class="n">insert</span> <span class="k">in</span> <span class="n">diff</span><span class="o">.</span><span class="n">insertion</span> <span class="p">{</span>
        <span class="n">copy</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">insert</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">insert</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">copy</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It‚Äôs place for magic happen. [A] transform to [B] by applying DiffTransform one by one. We start with Deletion Transform firstly, then Insertion Transform. We also able to apply ReloadTransform, but it this case, we‚Äôre working on String, we don‚Äôt need to reload it-self.</p>

<h3 id="test-with-string">Test with String</h3>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Test</span>
<span class="k">let</span> <span class="nv">a</span> <span class="o">=</span> <span class="p">[</span><span class="s">"A"</span><span class="p">,</span> <span class="s">"D"</span><span class="p">,</span> <span class="s">"F"</span><span class="p">,</span> <span class="s">"G"</span><span class="p">,</span> <span class="s">"T"</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">b</span> <span class="o">=</span> <span class="p">[</span><span class="s">"A"</span><span class="p">,</span> <span class="s">"F"</span><span class="p">,</span> <span class="s">"O"</span><span class="p">,</span> <span class="s">"X"</span><span class="p">,</span> <span class="s">"T"</span><span class="p">]</span>
 
<span class="k">let</span> <span class="nv">diff</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="nf">diff</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> 
<span class="c1">// diff = [Reload((0)[A]), Delete((1)[D]), Reload((2)[F]), Insert((2)[O]),</span>
<span class="kt">Insert</span><span class="p">((</span><span class="mi">3</span><span class="p">)[</span><span class="kt">X</span><span class="p">]),</span> <span class="kt">Delete</span><span class="p">((</span><span class="mi">3</span><span class="p">)[</span><span class="kt">G</span><span class="p">]),</span> <span class="kt">Reload</span><span class="p">((</span><span class="mi">4</span><span class="p">)[</span><span class="kt">T</span><span class="p">])]</span>
 
<span class="k">let</span> <span class="nv">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="c1">// c = ["A", "F", "O", "X", "T"]</span>
</code></pre></div></div>

<p>Sound easy, right? üòâ The Diff is the optimize way as possible, and it does 100% automatically. Life is easy now ü§ó</p>

<h2 id="2-integration-with-uitableview">2. Integration with UITableView</h2>

<p>We create DiffCalculator struct to handle all transform logic for UITableView. It stores tableview as weak variable (We don‚Äôt want to make cycle-retain right?), and data model.</p>

<p>The especially things is Setter of data. We calculate the DiffTransform for Insertion/Deletion/Reload, then performing the transform in <beginUpdate> and <endUpdate></endUpdate></beginUpdate></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// UITable View Integration</span>
<span class="kd">struct</span> <span class="kt">DiffCalculator</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Equatable</span><span class="o">&gt;</span> <span class="p">{</span>
    
    <span class="c1">// Weak table view</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">?</span>
    
    <span class="c1">// Data</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">_data</span><span class="p">:</span> <span class="p">[</span><span class="kt">T</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">var</span> <span class="nv">data</span><span class="p">:</span> <span class="p">[</span><span class="kt">T</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span><span class="k">return</span> <span class="k">self</span><span class="o">.</span><span class="n">_data</span><span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">old</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">_data</span>
            <span class="k">let</span> <span class="nv">diff</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="nf">diff</span><span class="p">(</span><span class="n">newValue</span><span class="p">)</span>
            
            <span class="c1">// Set</span>
            <span class="k">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">newValue</span>
            
            <span class="c1">// Transform</span>
            <span class="k">self</span><span class="o">.</span><span class="nf">applyTransform</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">diff</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//</span>
    <span class="c1">// MARK: - Init</span>
    <span class="nf">init</span><span class="p">(</span><span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="p">[</span><span class="kt">T</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tableView</span> <span class="o">=</span> <span class="n">tableView</span>
        <span class="k">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
    <span class="p">}</span>
    
    <span class="c1">// Apply Transfrom</span>
    <span class="kd">fileprivate</span> <span class="kd">func</span> <span class="n">applyTransform</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Equatable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">with</span> <span class="nv">diff</span><span class="p">:</span> <span class="kt">Diff</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="c1">// Update transform</span>
        <span class="k">guard</span> <span class="n">diff</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span><span class="k">return</span><span class="p">}</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">tableView</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">tableView</span> <span class="k">else</span> <span class="p">{</span><span class="k">return</span><span class="p">}</span>
        
        <span class="n">tableView</span><span class="o">.</span><span class="nf">beginUpdates</span><span class="p">()</span>
        
        <span class="c1">// Map indexPath</span>
        <span class="k">let</span> <span class="nv">insertion</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">insertion</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="nv">$0</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">})</span>
        <span class="k">let</span> <span class="nv">deletion</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">deletion</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="nv">$0</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">})</span>
        <span class="k">let</span> <span class="nv">reload</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="nf">map</span><span class="p">({</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="nv">$0</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">})</span>
        
        <span class="c1">// Delete</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">deletion</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">insertRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">insertion</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">reload</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        
        <span class="n">tableView</span><span class="o">.</span><span class="nf">endUpdates</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Using DiffCaculator is really simple.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Example</span>
<span class="k">let</span> <span class="nv">tableView</span> <span class="o">=</span> <span class="kt">UITableView</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Nghia Tran"</span><span class="p">,</span> <span class="s">"nghiatran.me"</span><span class="p">,</span> <span class="s">"Saigon"</span><span class="p">,</span> <span class="s">"Singapore"</span><span class="p">,</span> <span class="s">"Bangkok"</span><span class="p">]</span>
<span class="k">var</span> <span class="nv">diffCalculator</span> <span class="o">=</span> <span class="kt">DiffCalculator</span><span class="o">&lt;</span><span class="kt">String</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">tableView</span><span class="p">:</span> <span class="n">tableView</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
 
<span class="c1">// Using diffCalculator.data as dataSource for UITableView.</span>
 
<span class="c1">// Pull to refresh with new data</span>
<span class="k">let</span> <span class="nv">newData</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Nghia Tran"</span><span class="p">,</span> <span class="s">"Uni"</span><span class="p">,</span> <span class="s">"nghiatran.me"</span><span class="p">,</span> <span class="s">"Ha Noi"</span><span class="p">,</span> <span class="s">"KL"</span><span class="p">,</span> <span class="s">"Singapore"</span><span class="p">,</span> <span class="s">"Bangkok"</span><span class="p">,</span> <span class="s">"Finland"</span><span class="p">]</span>
 
<span class="c1">// Update new data</span>
<span class="c1">// Table reload with optimize way.</span>
<span class="n">diffCalculator</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">newData</span>
</code></pre></div></div>

<h2 id="3-benchmark">3. Benchmark</h2>

<p>For demonstration, I write a simple app with smallDataSource (10 rows) and reload with large DataSource (20 rows) (simulate it‚Äôs from API).</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/diff_app.jpg" alt="" /></p>

<p>On my purpose, the size of cells are dynamic, and collectionView inside each cell and the quality of images are high. Because we want to see the benchmark clearly. So make it‚Äôs more complex.</p>

<p>The Sample app has 3 tabs, stand for each approach we‚Äôve discussed: Force Reload, manually calculate, and Diff algorithm.</p>

<p>On this benchmark, I will test on my <strong>iPhone 5</strong>, gain accurate results, it will reflect efficiency for each solution.</p>

<h3 id="31-force-reloaddata">3.1 Force reloadData()</h3>

<p>By calling tableView.reloadData() is naive solution we could do. As you can see clearly, the first peak intends for the first time we reload and fill data into UITableView.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/diff_benchmark_reload_2.jpg" alt="" /></p>

<p>Noticeable, the second peak really impacts our performance. It costs <strong>47%</strong>. Because the table view must calculate the dynamic size on runtime, get minimum size which matched cell‚Äôs constraints, it depends on length of comment string. And reload the collectionview built-in the cell.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// My Purpose</span>
<span class="c1">// Don't Cache image in memory</span>
<span class="c1">// Just make it complex to render -&gt; Easier to analytic in Instrustment</span>
<span class="k">let</span> <span class="nv">path</span> <span class="o">=</span> <span class="kt">Bundle</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">path</span><span class="p">(</span><span class="nv">forResource</span><span class="p">:</span> <span class="n">imageName</span><span class="p">,</span> <span class="nv">ofType</span><span class="p">:</span> <span class="s">"jpg"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">image</span> <span class="o">=</span> <span class="kt">UIImage</span><span class="p">(</span><span class="nv">contentsOfFile</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>
 
<span class="k">self</span><span class="o">.</span><span class="n">imageView</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>

</code></pre></div></div>

<p>Please bear in mind, I did it on my purpose. Because in a¬†real world, the layout of cells are¬†most complex. And of course, as¬†more as complex we can see the result clearly.</p>

<h3 id="32-do-manually">3.2 Do manually</h3>

<p>Here is sample data: The data source of Feed screen doesn‚Äôt order by created_at, it looks like random, depend on the ‚Äúscore‚Äù of each Item.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">initalData</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_1</span><span class="p">,</span> <span class="n">data_2</span><span class="p">,</span> <span class="n">data_3</span><span class="p">,</span> <span class="n">data_4</span><span class="p">,</span> <span class="n">data_5</span><span class="p">,</span> <span class="n">data_6</span><span class="p">,</span> <span class="n">data_7</span><span class="p">,</span> <span class="n">data_8</span><span class="p">,</span> <span class="n">data_9</span><span class="p">,</span> <span class="n">data_10</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">newData</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_1</span><span class="p">,</span> <span class="n">data_4</span><span class="p">,</span> <span class="n">data_5</span><span class="p">,</span> <span class="n">data_6</span><span class="p">,</span> <span class="n">data_3</span><span class="p">,</span> <span class="n">data_9</span><span class="p">,</span> <span class="n">data_2</span><span class="p">]</span>
</code></pre></div></div>

<p>How could I do manually? ü§î</p>

<p>How could I get <strong>insertIndexPaths</strong>¬†and¬†<strong>deleteIndexPaths</strong> then passing into insertRows/DeleteRows ü§î</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Reload</span>
<span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">beginUpdates</span><span class="p">()</span>
<span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">insertRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">insertIndexPaths</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="k">none</span><span class="p">)</span>
<span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">deleteIndexPaths</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="k">none</span><span class="p">)</span>
<span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">endUpdates</span><span class="p">()</span>
</code></pre></div></div>

<p>Really hard, right? ü§î</p>

<p>Yeah, if you‚Äôre struggling to solve it, there are no change to make sure your result is optimization. Or you might get mistake, and your app is crashed completely.</p>

<p>Diff algorithm is a rescue now ü§ó</p>

<h3 id="33-diff-algorithm">3.3 Diff algorithm</h3>

<p>It‚Äôs the perfect time to reused DiffCalculator which we implemented in the beginning.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Initial diff</span>
<span class="k">self</span><span class="o">.</span><span class="n">diffCalculator</span> <span class="o">=</span> <span class="kt">DiffCalculator</span><span class="o">&lt;</span><span class="kt">FeedObj</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">tableView</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">feedObjs</span><span class="p">)</span>
 
<span class="c1">// From API</span>
<span class="k">let</span> <span class="nv">newData</span> <span class="o">=</span> <span class="kt">FeedObj</span><span class="o">.</span><span class="nf">pullNewLargeDataSource</span><span class="p">()</span>
<span class="k">self</span><span class="o">.</span><span class="n">feedObjs</span> <span class="o">=</span> <span class="n">newData</span>
 
<span class="c1">// Make Dif and reload automatically + optimazation</span>
<span class="k">self</span><span class="o">.</span><span class="n">diffCalculator</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">newData</span>
</code></pre></div></div>

<p>It‚Äôs completely straight-forward. Just initialize self.diffCalculator and set data with new data from API. DiffCalculator will do difficult part for us.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="kt">Delete</span><span class="p">((</span><span class="mi">1</span><span class="p">)[</span><span class="kt">Diff</span><span class="o">.</span><span class="kt">FeedObj</span><span class="p">]),</span> <span class="kt">Delete</span><span class="p">((</span><span class="mi">2</span><span class="p">)[</span><span class="kt">Diff</span><span class="o">.</span><span class="kt">FeedObj</span><span class="p">]),</span> <span class="kt">Insert</span><span class="p">((</span><span class="mi">4</span><span class="p">)[</span><span class="kt">Diff</span><span class="o">.</span><span class="kt">FeedObj</span><span class="p">]),</span>
 <span class="kt">Delete</span><span class="p">((</span><span class="mi">6</span><span class="p">)[</span><span class="kt">Diff</span><span class="o">.</span><span class="kt">FeedObj</span><span class="p">]),</span> <span class="kt">Delete</span><span class="p">((</span><span class="mi">7</span><span class="p">)[</span><span class="kt">Diff</span><span class="o">.</span><span class="kt">FeedObj</span><span class="p">]),</span><span class="kt">Insert</span><span class="p">((</span><span class="mi">6</span><span class="p">)[</span><span class="kt">Diff</span><span class="o">.</span><span class="kt">FeedObj</span><span class="p">]),</span>
 <span class="kt">Delete</span><span class="p">((</span><span class="mi">9</span><span class="p">)[</span><span class="kt">Diff</span><span class="o">.</span><span class="kt">FeedObj</span><span class="p">])]</span>
</code></pre></div></div>

<p>We only need 6 steps to transform. It‚Äôs optimization approach for now ü§ó</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/diff_benchmark_small_data_source.jpg" alt="" /></p>

<p>The result doesn‚Äôt make us disappointed. From <strong>47%</strong>, we reduce to <strong>21%</strong>. Good point üíØ</p>

<h3 id="summary-1">Summary</h3>

<ul>
  <li>Get perfect transform between 2 data source, absolutely optimize than doing by hand manually</li>
  <li>100% calculate automatically.</li>
  <li>Avoid crash unexpected.</li>
  <li>Suitable for complex tableview/collectionview.</li>
</ul>

<h2 id="4-drawback">4. Drawback</h2>

<p>Everything has two sides, it‚Äôs unfair if we only mention the bright side. Does Diff algorithm (based on LCS) have any disadvantage? ü§î</p>

<p>Let try on large set of data. The initial data has 100 item, and new data has 210 item, and do each step which same we did.</p>

<p><img src="https://raw.githubusercontent.com/NghiaTranUIT/nghiatranuit.github.io/master/resources/2017/03/diff_benchmark_large_data_source.jpg" alt="" /></p>

<p>Wow, <strong>56%</strong> CPU for Diff. What‚Äôs wrong here ü§î. As big as data source‚Äôs length could be, the time for Diff¬†increases significantly.</p>

<p>The problem is time complexity of Diff is <strong>O(n <em>¬†m)**. So we have 100</em>210 = 210,000 cell in¬†memorization-table, and of course, cost more CPU¬†to iterate through the¬†table.
Diff algorithm which we discussed is based on **LCS</strong> [Part 1]. ¬†So it‚Äôs not best algorithm we could implement. I choice this approach because it‚Äôs simple, and it‚Äôs relevant with <a href="http://nghiatran.me/longest-common-subsequence-diff-part-1/">Part 1</a>.</p>

<h2 id="5-whats-next">5. What‚Äôs next?</h2>

<p>In next chapter, we will discuss¬†<strong>Paul Heckel‚Äôs Diff</strong>.</p>

<p>This algorithm finds all the possible update that UITableView needs in **linear time **O(n) . It‚Äôs most efficiently approach which widely used in applications. Moreover, <a href="https://engineering.instagram.com/open-sourcing-iglistkit-3d66f1e4e9aa#.p8ojr79an">IGListKit</a> also uses it as back core as well. ü§ó</p>

<h2 id="6-where-to-go-from-here">6. Where to go from here?</h2>

<p><a href="‚Äùhttps://github.com/NghiaTranUIT/LCS-Swift">iOS diff on Github</a></p>

<p>Hope you enjoy my blog about LCS and Diff on iOS Development üëç</p>

<p>Diff algorithm and integration with UITableView which I cover, it‚Äôs not perfect optimize solution. It‚Äôs perfect place for beginner. There are various¬†algorithms to improve the time complexity. One of them¬†is <a href="https://gist.github.com/ndarville/3166060">Paul Heckel‚Äôs Diff</a> (was published 1978).</p>

<p>If you would like to take a deep research, take a look at <a href="https://github.com/Instagram/IGListKit">IGListKit</a> by Instagram Engineer, and <a href="https://engineering.instagram.com/open-sourcing-iglistkit-3d66f1e4e9aa#.4xyqertyv">their blog</a>.</p>

<p>If you need more challenge. Here is the puzzle:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">DiffCalculator</span> <span class="n">has</span> <span class="n">limited</span> <span class="n">when</span> <span class="n">only</span> <span class="n">working</span> <span class="n">with</span> <span class="kt">UITableView</span><span class="o">.</span>
<span class="kt">How</span> <span class="n">about</span> <span class="kt">UICollectionView</span><span class="p">,</span> <span class="n">maybe</span> <span class="n">we</span><span class="err">'</span><span class="n">re</span> <span class="n">missing</span> <span class="n">it</span> <span class="p">?</span>
 
<span class="kt">Challenge</span> <span class="n">yourself</span> <span class="n">and</span> <span class="n">implement</span> <span class="kt">DiffCalculate</span> <span class="n">generic</span> <span class="kd">protocol</span> <span class="n">instead</span> <span class="n">of</span> <span class="kd">struct</span><span class="o">.</span>
<span class="kt">Make</span> <span class="n">a</span> <span class="k">default</span> <span class="kd">extension</span><span class="p">,</span> <span class="n">and</span> <span class="n">adopt</span> <span class="n">it</span> <span class="n">with</span> <span class="n">both</span> <span class="n">of</span> <span class="kt">TableView</span><span class="o">/</span><span class="kt">CollectionView</span><span class="o">.</span>
 
<span class="kt">Final</span> <span class="nv">result</span><span class="p">:</span> <span class="kt">DiffCalculateProtocol</span> <span class="n">will</span> <span class="n">work</span> <span class="n">with</span> <span class="kt">UITableView</span> <span class="n">and</span> <span class="kt">UICollectionView</span> <span class="n">or</span> <span class="n">any</span>  <span class="n">with</span> <span class="n">less</span> <span class="n">duplicated</span> <span class="n">code</span><span class="p">,</span> <span class="n">reusable</span><span class="o">.</span>
 
<span class="kt">Let</span> <span class="k">do</span> <span class="n">it</span> <span class="n">üòé</span>
</code></pre></div></div>

<p>¬†</p>

<p>¬†</p>

:ET